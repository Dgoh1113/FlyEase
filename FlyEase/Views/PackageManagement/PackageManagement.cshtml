@model FlyEase.Models.PackageManagementViewModel

@{
    ViewData["Title"] = " - FlyEase Travel - PackageManagement Package Management";
    Layout = "~/Views/Shared/_Layout.cshtml";

}




<link rel="stylesheet" href="~/css/packagemanagement.css" />

<div class="management-hero">
    <div class="hero-content">
        <h1>Package Management</h1>
        <p>Create, edit, and manage travel packages</p>
    </div>
</div>

<div class="management-container">
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")">
            @Model.Message
        </div>
    }

    <div class="management-grid">
        <!-- Form Section -->
        <div class="form-card">
            <div class="form-header">
                <h3>@(Model.EditingPackageId == null ? "Create New Package" : "Edit Package")</h3>
            </div>
            <div class="form-body">
                <form method="post"
                      action="@(Model.EditingPackageId == null ? Url.Action("Create") : Url.Action("Update"))"
                      enctype="multipart/form-data">
                    @Html.AntiForgeryToken()

                    @if (Model.EditingPackageId.HasValue)
                    {
                        <input type="hidden" name="PackageID" value="@Model.EditingPackageId.Value" />
                    }

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Package Name</label>
                            <input class="form-control" name="PackageName"
                                   value="@Model.Package.PackageName" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="CategoryID" id="categorySelect">
                                <option value="">Select Category or Type New One</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.CategoryID"
                                            selected="@(category.CategoryID == Model.SelectedCategoryId)">
                                        @category.CategoryName
                                    </option>
                                }
                            </select>
                            <div class="mt-2">
                                <small class="text-muted">Or enter new category:</small>
                                <input type="text" class="form-control mt-1" name="NewCategoryName"
                                       id="newCategoryInput" placeholder="Type new category name"
                                       style="@(Model.SelectedCategoryId.HasValue ? "display:none;" : "")" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="Description" rows="3">@Model.Package.Description</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Destination</label>
                            <input class="form-control" name="Destination"
                                   value="@Model.Package.Destination" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input class="form-control" name="Price" type="number" step="0.01"
                                   value="@Model.Package.Price" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input class="form-control" name="StartDate" type="date"
                                   value="@(Model.Package.StartDate == default ? "" : Model.Package.StartDate.ToString("yyyy-MM-dd"))" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input class="form-control" name="EndDate" type="date"
                                   value="@(Model.Package.EndDate == default ? "" : Model.Package.EndDate.ToString("yyyy-MM-dd"))" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Available Slots</label>
                            <input class="form-control" name="AvailableSlots" type="number"
                                   value="@(Model.Package.AvailableSlots == 0 ? "" : Model.Package.AvailableSlots.ToString())" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Package Image</label>
                            <input class="form-control" name="ImageFile" type="file"
                                   accept="image/*" />
                            <small class="form-text text-muted">
                                Supported formats: JPG, JPEG, PNG, GIF, WebP. Max size: 5MB.
                                Image will be saved to: wwwroot/img/
                            </small>
                            @if (Model.EditingPackageId.HasValue && !string.IsNullOrEmpty(Model.Package.ImageURL))
                            {
                                <div class="mt-2">
                                    <small>Current Image:</small><br />
                                    <img src="@Model.Package.ImageURL" alt="Current package image"
                                         style="max-width: 100px; max-height: 100px; border-radius: 5px;"
                                         onerror="this.src='/img/default-package.jpg'" />
                                    <br />
                                    <small class="text-muted">Leave empty to keep current image</small>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Package Inclusions -->
                    <div class="form-group">
                        <label class="form-label">Package Inclusions</label>
                        <div id="inclusions-container">
                            @for (int i = 0; i < Model.Inclusions.Count; i++)
                            {
                                <div class="inclusion-item mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="Inclusions[@i]"
                                               value="@Model.Inclusions[i]" placeholder="Enter inclusion item" />
                                        <button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button>
                                    </div>
                                </div>
                            }
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addInclusion()">Add Inclusion</button>
                    </div>

                    <div class="form-actions">
                        @if (Model.EditingPackageId == null)
                        {
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Package
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Update Package
                            </button>
                            <form method="post" action="@Url.Action("Cancel")" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </form>
                        }
                    </div>
                </form>
            </div>
        </div>

        <!-- Packages List Section -->
        <div class="list-card">
            <div class="list-header">
                <h3>Existing Packages</h3>
            </div>
            <div class="packages-grid">
                @if (Model.Packages.Any())
                {
                    @foreach (var package in Model.Packages)
                    {
                        <div class="package-management-card">
                            <div class="package-image">
                                <img src="@(string.IsNullOrEmpty(package.ImageURL) ? "/img/default-package.jpg" : package.ImageURL)"
                                     alt="@package.PackageName"
                                     onerror="this.src='/img/default-package.jpg'" />
                                <div class="package-actions">
                                    <form method="post" action="@Url.Action("Edit")">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </form>
                                    <form method="post" action="@Url.Action("Delete")"
                                          onsubmit="return confirm('Are you sure you want to delete this package?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="package-content">
                                <h4>@package.PackageName</h4>
                                <div class="package-category">
                                    <strong>Category:</strong> @package.Category?.CategoryName
                                </div>
                                <div class="package-destination">
                                    <strong>Destination:</strong> @package.Destination
                                </div>
                                <div class="package-price">$@package.Price.ToString("N2")</div>
                                <p class="package-description">
                                    @(package.Description?.Length > 100 ? package.Description.Substring(0, 100) + "..." : package.Description)
                                </p>
                                <div class="package-details">
                                    <span><strong>Start:</strong> @package.StartDate.ToString("MMM dd, yyyy")</span>
                                    <span><strong>End:</strong> @package.EndDate.ToString("MMM dd, yyyy")</span>
                                    <span><strong>Slots:</strong> @package.AvailableSlots</span>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h4>No Packages Found</h4>
                        <p>Create your first package to get started!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let inclusionIndex = @Model.Inclusions.Count;
                // File validation
              // File validation (optional - you can remove this entirely if you want)
        document.querySelector('input[name="ImageFile"]')?.addEventListener('change', function(e) {
            const file = this.files[0];
            if (file) {
                // Only check file size (5MB max) - remove file type restrictions
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB.');
                    this.value = '';
                    return;
                }

                // Optional: Show warning for non-image files but don't block
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.tiff'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!imageExtensions.includes(fileExtension)) {
                    if (!confirm('This file may not be an image. Do you want to continue?')) {
                        this.value = '';
                        return;
                    }
                }
            }
        });
        function addInclusion() {
            const container = document.getElementById('inclusions-container');
            const div = document.createElement('div');
            div.className = 'inclusion-item mb-2';
            div.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" name="Inclusions[${inclusionIndex}]" placeholder="Enter inclusion item" />
                    <button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button>
                </div>
            `;
            container.appendChild(div);
            inclusionIndex++;
        }

        function removeInclusion(button) {
            button.closest('.inclusion-item').remove();
        }

        // Form validation
        document.querySelector('form').addEventListener('submit', function (e) {
            const startDateInput = document.querySelector('input[name="StartDate"]');
            const endDateInput = document.querySelector('input[name="EndDate"]');
            const priceInput = document.querySelector('input[name="Price"]');
            const slotsInput = document.querySelector('input[name="AvailableSlots"]');

            if (startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);

                if (endDate <= startDate) {
                    e.preventDefault();
                    alert('End date must be after start date.');
                    return false;
                }
            }

            if (priceInput.value && parseFloat(priceInput.value) <= 0) {
                e.preventDefault();
                alert('Price must be greater than 0.');
                return false;
            }

            if (slotsInput.value && parseInt(slotsInput.value) <= 0) {
                e.preventDefault();
                alert('Available slots must be greater than 0.');
                return false;
            }

            // Validate that at least one inclusion exists
            const inclusionInputs = document.querySelectorAll('input[name^="Inclusions"]');
            let hasValidInclusion = false;
            inclusionInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    hasValidInclusion = true;
                }
            });

            if (!hasValidInclusion) {
                e.preventDefault();
                alert('Please add at least one package inclusion.');
                return false;
            }
        });

        // Initialize - add one empty inclusion if none exist
        document.addEventListener('DOMContentLoaded', function() {
            const inclusionInputs = document.querySelectorAll('input[name^="Inclusions"]');
            if (inclusionInputs.length === 0) {
                addInclusion();
            }
        });
    </script>
}