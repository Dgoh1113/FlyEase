 url=https://github.com/Dgoh1113/FlyEase/blob/aecf959a3e8037fc3156141403adc17925e03d9d/FlyEase/Views/PackageManagement/PackageManagement.cshtml
@model FlyEase.ViewModels.PackageViewModel

@{
    ViewData["Title"] = "Manage Packages";
}

<!-- ... top markup (cards, alerts) ... -->
<!-- Form: give it an id so we can attach a submit handler that runs the same validation as the button -->
<form asp-action="Create" id="packageForm" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label asp-for="PackageName" class="form-label"></label>
        <input asp-for="PackageName" class="form-control" />
        <span asp-validation-for="PackageName" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label" for="CategoryID">Category</label>

        <!-- Category select: default empty value ("") so model binding gives null and our validation can run -->
        <select asp-for="CategoryID" asp-items="new SelectList(ViewBag.Categories, " CategoryID", "CategoryName" )" class="form-select" id="CategoryID" onchange="handleCategoryChange(this)">
            <option value="">-- Select existing category --</option>
        </select>
        <span asp-validation-for="CategoryID" class="text-danger"></span>

        <div class="mt-2">
            <label asp-for="NewCategoryName" class="form-label"></label>
            <input asp-for="NewCategoryName" class="form-control" maxlength="100" />
            <span asp-validation-for="NewCategoryName" class="text-danger"></span>
            <small class="form-text text-muted">If you want to create a new category, type its name here. Allowed characters: letters, numbers, spaces, hyphens.</small>
        </div>
    </div>

    <!-- rest of the form fields (Destination, Price, Dates, Slots, Image upload) -->
    <div class="mb-3">
        <label asp-for="Destination" class="form-label"></label>
        <input asp-for="Destination" class="form-control" />
        <span asp-validation-for="Destination" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Price" class="form-label"></label>
        <input asp-for="Price" class="form-control" />
        <span asp-validation-for="Price" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="StartDate" class="form-label"></label>
        <input asp-for="StartDate" type="date" class="form-control" id="StartDate" />
        <span asp-validation-for="StartDate" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="EndDate" class="form-label"></label>
        <input asp-for="EndDate" type="date" class="form-control" id="EndDate" />
        <span asp-validation-for="EndDate" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="AvailableSlots" class="form-label"></label>
        <input asp-for="AvailableSlots" class="form-control" />
        <span asp-validation-for="AvailableSlots" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ImageFile" class="form-label"></label>
        <input asp-for="ImageFile" type="file" class="form-control" accept=".jpg,.jpeg,.png,.gif,.webp" />
        <span asp-validation-for="ImageFile" class="text-danger"></span>
        <small class="form-text text-muted">Supported formats: JPG, JPEG, PNG, GIF, WebP. Max size: 5MB.</small>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="createButton">
            <i class="fas fa-plus"></i> Create Package
        </button>
    </div>
</form>

<!-- packages list and other markup ... -->
@section Scripts {
    <script>
        // Auto-hide alerts after 5 seconds
        setTimeout(function () {
            $('.alert').fadeOut('slow');
        }, 5000);

        // Set min date for date inputs to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const startDate = document.getElementById('StartDate');
            const endDate = document.getElementById('EndDate');

            if (startDate) {
                startDate.min = today;
                if (!startDate.value) {
                    startDate.value = today;
                }
            }
            if (endDate) {
                endDate.min = today;
                if (!endDate.value) {
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    endDate.value = nextWeek.toISOString().split('T')[0];
                }
            }

            if (startDate && endDate) {
                startDate.addEventListener('change', function() {
                    endDate.min = this.value;
                    if (endDate.value < this.value) {
                        endDate.value = this.value;
                    }
                });
            }

            // Initialize category handling & file validation
            initializeCategoryHandling();
            initializeFileUploadValidation();

            // Attach a submit handler so Enter key and other submit routes run the category validation
            var packageForm = document.getElementById('packageForm');
            if (packageForm) {
                packageForm.addEventListener('submit', function (e) {
                    if (!validateCategory()) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });
            }
        });

        // Category handling
        function handleCategoryChange(select) {
            const newCategoryInput = document.getElementById('NewCategoryName');
            if (select.value) {
                // Existing category selected, clear new category input error
                if (newCategoryInput) {
                    newCategoryInput.value = '';
                }
            }
        }

        function initializeCategoryHandling() {
            const categorySelect = document.getElementById('CategoryID');
            const newCategoryInput = document.getElementById('NewCategoryName');

            // If new category has value, clear the select
            if (newCategoryInput && newCategoryInput.value) {
                categorySelect.value = '';
            }

            // If user types in new category, clear the select
            if (newCategoryInput) {
                newCategoryInput.addEventListener('input', function() {
                    if (this.value) {
                        categorySelect.value = '';
                    }
                });
            }
        }

        // Validate category on client: show specific messages for missing/invalid input
        function validateCategory() {
            const categorySelect = document.getElementById('CategoryID');
            const newCategoryInput = document.getElementById('NewCategoryName');

            const categorySelected = categorySelect && categorySelect.value;
            const newCategoryValue = newCategoryInput ? newCategoryInput.value.trim() : '';

            // If neither provided
            if (!categorySelected && !newCategoryValue) {
                // Attach client-side message to validation span(s)
                var catSpan = document.querySelector('[data-valmsg-for="CategoryID"]');
                var newCatSpan = document.querySelector('[data-valmsg-for="NewCategoryName"]');
                if (catSpan) catSpan.textContent = 'Please select an existing category or enter a new category name.';
                if (newCatSpan) newCatSpan.textContent = 'Please select an existing category or enter a new category name.';
                return false;
            }

            // If user provided a new category, validate pattern client-side
            if (newCategoryValue) {
                const regex = /^[A-Za-z0-9\s\-]{1,100}$/;
                if (!regex.test(newCategoryValue)) {
                    var newCatSpan = document.querySelector('[data-valmsg-for="NewCategoryName"]');
                    if (newCatSpan) newCatSpan.textContent = 'Category name must be 1-100 characters and contain only letters, numbers, spaces or hyphens.';
                    return false;
                }
            }

            // Clear validation messages if valid
            var catSpanClear = document.querySelector('[data-valmsg-for="CategoryID"]');
            var newCatSpanClear = document.querySelector('[data-valmsg-for="NewCategoryName"]');
            if (catSpanClear) catSpanClear.textContent = '';
            if (newCatSpanClear) newCatSpanClear.textContent = '';

            return true;
        }

        // File upload validation (unchanged)
        function initializeFileUploadValidation() {
            const fileInput = document.querySelector('input[type="file"]');

            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

                    if (file) {
                        // Check file type
                        if (!allowedTypes.includes(file.type)) {
                            alert('Invalid file type. Please select JPG, JPEG, PNG, GIF, or WebP image.');
                            e.target.value = '';
                            return;
                        }

                        // Check file size
                        if (file.size > maxSize) {
                            alert('File size too large. Maximum size is 5MB.');
                            e.target.value = '';
                            return;
                        }

                        // Preview image (optional)
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            // show preview if you have an element for it
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
    </script>

    <!-- Ensure unobtrusive validation works: these files should already exist in your wwwroot/lib folder -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.js"></script>
}