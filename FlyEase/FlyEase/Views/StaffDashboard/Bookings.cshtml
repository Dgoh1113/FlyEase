@model FlyEase.ViewModels.BookingsPageVM
@{
    ViewData["Title"] = "Bookings Management";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Bookings Management</h2>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0">All Bookings</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Package Info</th>
                        <th>Travel Date</th>
                        <th>Financials</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Bookings == null || !Model.Bookings.Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">No bookings found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model.Bookings)
                        {
                            // 1. FORCE "Confirmed" to look/act like "Pending"
                            var displayStatus = (item.BookingStatus == "Confirmed") ? "Pending" : item.BookingStatus;

                            // 2. Calculate payments
                            var totalPaid = item.Payments?.Sum(p => p.AmountPaid) ?? 0;
                            var balanceDue = item.FinalAmount - totalPaid;

                            // 3. Payment Status Logic
                            string payStatus = "Unpaid";
                            if (item.FinalAmount == 0) { payStatus = "Free"; }
                            else if (totalPaid >= item.FinalAmount) { payStatus = "Fully Paid"; }
                            else if (totalPaid > 0) { payStatus = "Partial"; }

                            // 4. Badge Color Logic (Based on displayStatus)
                            string badgeClass = "bg-secondary";
                            switch (displayStatus)
                            {
                                case "Completed": badgeClass = "bg-success"; break;       // Green
                                case "Pending": badgeClass = "bg-warning text-dark"; break; // Yellow
                                case "Cancelled": badgeClass = "bg-danger"; break;        // Red
                            }

                            <tr>
                                <td><strong>#@item.BookingID</strong></td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">@item.User?.FullName</span>
                                        <small class="text-muted">@item.User?.Email</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="d-block text-truncate" style="max-width: 150px;" title="@item.Package?.PackageName">
                                        @item.Package?.PackageName
                                    </span>
                                    <small class="text-muted"><i class="bi bi-people"></i> @item.NumberOfPeople Pax</small>
                                </td>
                                <td>
                                    <div>@item.TravelDate.ToString("MMM dd, yyyy")</div>
                                    <small class="text-muted">Booked: @item.BookingDate.ToString("MMM dd")</small>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">@item.FinalAmount.ToString("C")</span>

                                        @if (payStatus == "Fully Paid")
                                        {
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill" style="width:fit-content; font-size:0.7rem">Paid</span>
                                        }
                                        else if (payStatus == "Unpaid")
                                        {
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger rounded-pill" style="width:fit-content; font-size:0.7rem">Unpaid</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning rounded-pill" style="width:fit-content; font-size:0.7rem">Partial</span>
                                        }

                                        @if (balanceDue > 0)
                                        {
                                            <small class="text-danger" style="font-size:0.75rem">Due: @balanceDue.ToString("C")</small>
                                        }
                                    </div>
                                </td>

                                <td>
                                    <span class="badge @badgeClass">@displayStatus</span>
                                </td>

                                <td>
                                    <button class="btn btn-sm btn-outline-primary manage-btn"
                                            onclick="openBookingModal(@item.BookingID, '@item.User?.FullName', '@displayStatus')">
                                        Manage
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Manage Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form asp-action="UpdateBookingStatus" method="post">
                <div class="modal-body">

                    <input type="hidden" id="b_id" asp-for="CurrentBooking.BookingID" />

                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="displayCustomerName" readonly disabled />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Booking Status</label>
                        <select id="b_status" asp-for="CurrentBooking.BookingStatus" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Completed">Completed</option>
                        </select>
                       
                        <div class="form-text text-muted">
                            Note: Cancelling a booking will release the slots back to the package.
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
				</div>
            </form>
        </div>
    </div>
</div>

<script>
       // This function receives 'displayStatus' (which is now "Pending")
    function openBookingModal(id, customerName, currentStatus) {
        document.getElementById('b_id').value = id;
        document.getElementById('displayCustomerName').value = customerName;
        document.getElementById('b_status').value = currentStatus; // Sets dropdown to Pending

        new bootstrap.Modal(document.getElementById('bookingModal')).show();
    }
</script>