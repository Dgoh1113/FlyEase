@model FlyEase.ViewModels.CustomerInfoViewModel
@{
    ViewData["Title"] = "Customer Information";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Head {
    <link rel="stylesheet" href="~/css/booking.css" />
    <style>
        .price-update-flash {
            animation: flashHighlight 1s;
        }

        @@keyframes flashHighlight {
            0% {
                background-color: #d4edda;
            }

            100% {
                background-color: transparent;
            }
        }

        .btn-voucher {
            border: 2px dashed #198754;
            color: #198754;
            background-color: #f8fff9;
            transition: all 0.3s;
        }

            .btn-voucher:hover {
                background-color: #198754;
                color: white;
                border-style: solid;
            }

        .discount-badge {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            border-left: 4px solid #0f5132;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Unavailable Style - RED */
        .btn-voucher-unavailable {
            background-color: #f8d7da !important;
            color: #842029 !important;
            border-color: #f5c2c7 !important;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Active/Selected Style */
        .btn-voucher-active {
            background-color: #198754 !important;
            color: white !important;
            border: 2px solid #0f5132 !important;
        }
    </style>
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <partial name="_BookingProgress" />

            <div class="card shadow-sm dashboard-card">
                <div class="card-header booking-header">
                    <h4 class="mb-0"><i class="fas fa-user me-2"></i>Customer Information</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Booking Summary</h6>
                        <p class="mb-1"><strong>Package:</strong> @Model.PackageName</p>
                        <p class="mb-1"><strong>Base Price:</strong> RM @Model.PackagePrice.ToString("N2") per person</p>
                    </div>

                    <form asp-action="CustomerInfo" method="post" id="customerForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="PackageID" id="hiddenPackageId" />
                        <input type="hidden" asp-for="PackageName" />

                        <input type="hidden" asp-for="PackagePrice" id="inputPackagePrice" />

                        <input type="hidden" asp-for="BasePrice" id="inputBasePrice" />
                        <input type="hidden" asp-for="DiscountAmount" id="inputDiscountAmount" />
                        <input type="hidden" asp-for="FinalAmount" id="inputFinalAmount" />

                        <input type="hidden" asp-for="VoucherCode" id="hiddenVoucherCode" />

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FullName" class="form-label">Full Name *</label>
                                <input asp-for="FullName" class="form-control" placeholder="Enter your full name">
                                <span asp-validation-for="FullName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label">Email Address *</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="your@email.com">
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label">Phone Number *</label>
                                <div class="input-group">
                                    <span class="input-group-text">+60</span>
                                    <input asp-for="Phone" class="form-control" placeholder="123456789">
                                </div>
                                <span asp-validation-for="Phone" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="TravelDate" class="form-label">Travel Date *</label>
                                <input asp-for="TravelDate" type="date" class="form-control" id="TravelDate"
                                       min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")"
                                       max="@DateTime.Now.AddYears(1).ToString("yyyy-MM-dd")">
                                <span asp-validation-for="TravelDate" class="text-danger small"></span>
                            </div>
                        </div>

                        <hr class="my-4" />
                        <h6 class="fw-bold mb-3">Traveler Details</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="NumberOfPeople" class="form-label">Total People</label>
                                <input asp-for="NumberOfPeople" type="number" class="form-control" id="numPeople" min="1" max="20" readonly>
                                <span asp-validation-for="NumberOfPeople" class="text-danger small"></span>
                            </div>

                            @if (ViewBag.HasSeniorParams == true)
                            {
                                <div class="col-md-4 mb-3">
                                    <label asp-for="NumberOfSeniors" class="form-label">Seniors (60+)</label>
                                    <input asp-for="NumberOfSeniors" type="number" class="form-control" id="numSeniors" min="0">
                                    <div class="form-text small text-success"><i class="fas fa-tag"></i> Senior Rate Applied</div>
                                </div>
                            }
                            else
                            {
                                <input type="hidden" asp-for="NumberOfSeniors" id="numSeniors" />
                            }

                            @if (ViewBag.HasJuniorParams == true)
                            {
                                <div class="col-md-4 mb-3">
                                    <label asp-for="NumberOfJuniors" class="form-label">Juniors </label>
                                    <input asp-for="NumberOfJuniors" type="number" class="form-control" id="numJuniors" min="0">
                                    <div class="form-text small text-success"><i class="fas fa-tag"></i> Junior Rate Applied</div>
                                </div>
                            }
                            else
                            {
                                <input type="hidden" asp-for="NumberOfJuniors" id="numJuniors" />
                            }
                        </div>

                        <div class="mb-3">
                            <label asp-for="Address" class="form-label">Address</label>
                            <textarea asp-for="Address" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="mb-4">
                            <label asp-for="SpecialRequests" class="form-label">Special Requests</label>
                            <textarea asp-for="SpecialRequests" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <button type="button" id="btnCheckVouchers" class="btn btn-voucher w-100 py-2 fw-bold">
                                <i class="fas fa-ticket-alt me-2"></i> Select Vouchers
                            </button>
                            <div id="voucherMessage" class="text-center mt-2 small text-muted"></div>
                        </div>

                        <div class="card mb-4 price-summary-custom" id="priceCard">
                            <div class="card-body">
                                <h6 class="card-title fw-bold">Price Breakdown</h6>
                                <div class="row">
                                    <div class="col-6"><small>Base Price:</small></div>
                                    <div class="col-6 text-end"><small id="displayBasePrice">RM @Model.BasePrice.ToString("N2")</small></div>
                                </div>
                                <div id="discountContainer" class="mt-2"></div>
                                <hr class="my-2">
                                <div class="row">
                                    <div class="col-6"><strong>Total Amount:</strong></div>
                                    <div class="col-6 text-end"><strong class="text-primary fs-5" id="displayFinalAmount">RM @Model.FinalAmount.ToString("N2")</strong></div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Packages", "Home")" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary fw-bold px-4">Continue <i class="fas fa-arrow-right ms-1"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="discountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-tags me-2"></i>Available Vouchers</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small mb-3">Click to select/deselect multiple vouchers.</div>
                <div id="modalDiscountList" class="list-group list-group-flush"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnVoucher = document.getElementById('btnCheckVouchers');
            const dateInput = document.getElementById('TravelDate');
            const packageId = document.getElementById('hiddenPackageId').value;
            const hiddenVoucherCode = document.getElementById('hiddenVoucherCode');
            const discountModal = new bootstrap.Modal(document.getElementById('discountModal'));

            // Inputs
            const elPeople = document.getElementById('numPeople');
            const elSeniors = document.getElementById('numSeniors');
            const elJuniors = document.getElementById('numJuniors');
            const elPrice = document.getElementById('inputPackagePrice'); // Raw package price

            // Store active codes as an array
            let activeCodes = [];

            // Initialize active codes from hidden input (if returning from server)
            if (hiddenVoucherCode.value) {
                activeCodes = hiddenVoucherCode.value.split(',').filter(c => c.trim() !== "");
            }

            function loadAllDiscounts() {
                const list = document.getElementById('modalDiscountList');
                list.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

                // GATHER CURRENT STATE FOR VALIDATION
                const currentPax = parseInt(elPeople.value) || 1;
                const unitPrice = parseFloat(elPrice.value) || 0;
                const currentSpend = currentPax * unitPrice;
                const travelDateVal = dateInput.value ? new Date(dateInput.value) : null;
                const today = new Date();
                today.setHours(0,0,0,0);

                fetch('/Payment/GetDiscounts')
                    .then(res => res.json())
                    .then(data => {
                        list.innerHTML = '';
                        if (data.length === 0) {
                            list.innerHTML = '<div class="text-center text-muted p-3">No vouchers available.</div>';
                            return;
                        }

                        data.forEach(d => {
                            let valueText = d.rate ? (d.rate * 100) + '% OFF' : 'RM ' + d.amount + ' OFF';

                            // === FRONTEND VALIDATION ===
                            let isAvailable = true;
                            let unavailableReason = "Unavailable";

                            if (d.minPax && currentPax < d.minPax) {
                                isAvailable = false;
                                unavailableReason = `Min ${d.minPax} Pax`;
                            }
                            if (d.minSpend && currentSpend < d.minSpend) {
                                isAvailable = false;
                                unavailableReason = `Min Spend RM${d.minSpend}`;
                            }
                            if (d.startDate && new Date(d.startDate) > today) {
                                isAvailable = false;
                                unavailableReason = "Not Started Yet";
                            }
                            if (d.endDate && new Date(d.endDate) < today) {
                                isAvailable = false;
                                unavailableReason = "Expired";
                            }

                            // CHECK IF ACTIVE
                            const isActive = activeCodes.includes(d.name);
                            const activeClass = isActive ? 'btn-voucher-active' : '';
                            const checkIcon = isActive ? '<i class="fas fa-check-circle me-1"></i>' : '';

                            if (isAvailable) {
                                // RENDER GREEN (CLICKABLE)
                                list.innerHTML += `
                                    <button type="button" id="vbtn-${d.name}"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${activeClass}"
                                        onclick="toggleDiscount('${d.name}')">
                                        <span>${checkIcon}<i class="fas fa-tag me-2"></i> ${d.name}</span>
                                        <span class="badge bg-success rounded-pill">${valueText}</span>
                                    </button>`;
                            } else {
                                // RENDER RED (DISABLED)
                                list.innerHTML += `
                                    <button type="button" class="list-group-item d-flex justify-content-between align-items-center btn-voucher-unavailable" disabled>
                                        <span><i class="fas fa-ban me-2"></i> ${d.name} <small>(${unavailableReason})</small></span>
                                        <span class="badge bg-secondary rounded-pill">Unavailable</span>
                                    </button>`;
                            }
                        });
                    });
            }

            // TOGGLE SELECTION FUNCTION
            window.toggleDiscount = function(code) {
                const idx = activeCodes.indexOf(code);
                const btn = document.getElementById(`vbtn-${code}`);

                if (idx > -1) {
                    // Remove
                    activeCodes.splice(idx, 1);
                    if(btn) {
                        btn.classList.remove('btn-voucher-active');
                        btn.querySelector('span').innerHTML = `<span><i class="fas fa-tag me-2"></i> ${code}</span>`; // Remove check icon
                    }
                } else {
                    // Add
                    activeCodes.push(code);
                    if(btn) {
                        btn.classList.add('btn-voucher-active');
                         btn.querySelector('span').innerHTML = `<i class="fas fa-check-circle me-1"></i><i class="fas fa-tag me-2"></i> ${code}`;
                    }
                }

                // Update hidden input
                hiddenVoucherCode.value = activeCodes.join(',');

                // Recalculate immediately
                calculatePrice();
            };

            // Modal Hide Event -> just ensure calc is fresh
            document.getElementById('discountModal').addEventListener('hidden.bs.modal', function () {
                calculatePrice();
            });

            btnVoucher.addEventListener('click', function() {
                const dateVal = dateInput.value;
                if (!dateVal) { alert("Please select a Travel Date first."); return; }
                discountModal.show();
                loadAllDiscounts();
            });

            if(elPeople) elPeople.addEventListener('change', calculatePrice);
            if(elSeniors && elSeniors.type !== 'hidden') elSeniors.addEventListener('change', calculatePrice);
            if(elJuniors && elJuniors.type !== 'hidden') elJuniors.addEventListener('change', calculatePrice);

            // Auto-calc if data exists (back button)
            if (hiddenVoucherCode.value || (elSeniors && elSeniors.value > 0) || (elJuniors && elJuniors.value > 0)) {
                calculatePrice();
            }

            function calculatePrice() {
                const dateVal = dateInput.value;
                if(!dateVal) return;

                const people = parseInt(elPeople.value) || 1;
                const seniors = parseInt(elSeniors.value) || 0;
                const juniors = parseInt(elJuniors.value) || 0;
                const voucherStr = hiddenVoucherCode.value || "";

                if (seniors + juniors > people) {
                    alert("Total Seniors and Juniors cannot exceed total people.");
                    return;
                }

                fetch('/Payment/CalculatePrice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        packageId: parseInt(packageId),
                        people: people,
                        seniors: seniors,
                        juniors: juniors,
                        travelDate: dateVal,
                        voucherCode: voucherStr // Sends "Code1,Code2"
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateUI(data);

                        // Update button text to reflect count
                        const count = activeCodes.length;
                        const msgDiv = document.getElementById('voucherMessage');

                        if(count > 0) {
                             btnVoucher.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${count} Voucher(s) Selected`;
                             btnVoucher.classList.add('btn-voucher-active');
                             msgDiv.innerHTML = `<span class="text-success fw-bold">Applied: ${activeCodes.join(', ')}</span>`;
                        } else {
                             btnVoucher.innerHTML = `<i class="fas fa-ticket-alt me-2"></i> Select Vouchers`;
                             btnVoucher.classList.remove('btn-voucher-active');
                             msgDiv.innerHTML = '';
                        }
                    }
                })
                .catch(console.error);
            }

            function updateUI(data) {
                document.getElementById('inputBasePrice').value = data.basePrice;
                document.getElementById('inputDiscountAmount').value = data.discountAmount;
                document.getElementById('inputFinalAmount').value = data.finalAmount;

                document.getElementById('displayBasePrice').innerText = 'RM ' + data.basePrice.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('displayFinalAmount').innerText = 'RM ' + data.finalAmount.toLocaleString(undefined, {minimumFractionDigits: 2});

                const container = document.getElementById('discountContainer');
                container.innerHTML = '';
                if (data.discountAmount > 0 && data.breakdown && data.breakdown.length > 0) {
                    data.breakdown.forEach(text => {
                        container.innerHTML += `<div class="discount-badge animate-slide-down"><span><i class="fas fa-tag me-1"></i> ${text}</span></div>`;
                    });
                    container.innerHTML += `
                        <div class="row mt-2">
                            <div class="col-6"><small>Total Discount:</small></div>
                            <div class="col-6 text-end"><small class="text-success">-RM ${data.discountAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}</small></div>
                        </div>`;
                } else {
                    container.innerHTML = '<div class="text-muted small text-center my-1">No additional discounts applied.</div>';
                }

                const card = document.getElementById('priceCard');
                card.classList.remove('price-update-flash');
                void card.offsetWidth;
                card.classList.add('price-update-flash');
            }
        });
    </script>
}