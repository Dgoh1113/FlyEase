@model FlyEase.ViewModels.AdminDashboardVM
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">Dashboard Overview</h2>
        <span class="badge bg-primary p-2">@DateTime.Now.ToString("dd MMM yyyy")</span>
    </div>

    <div class="row mb-4 g-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 py-2" style="border-left: 5px solid #4e73df;">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Revenue</div>
                    <div class="h5 mb-0 font-weight-bold">RM @Model.TotalRevenue.ToString("N0")</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4 g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100 dashboard-card">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-transparent border-bottom">
                    <h6 class="m-0 fw-bold text-primary">Revenue Overview</h6>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary active" onclick="updateRevenueChart('1year', this)">1 Year</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateRevenueChart('30days', this)">1 Month</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateRevenueChart('7days', this)">7 Days</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-scroll-wrapper" style="overflow-x: auto; width: 100%; padding-bottom: 10px;">
                        <div class="chart-area-container" style="height: 300px; min-width: 100%;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm h-100 dashboard-card">
                <div class="card-header py-3 bg-transparent border-bottom">
                    <h6 class="m-0 fw-bold text-primary">Top Packages</h6>
                </div>
                <div class="card-body position-relative">
                    <div style="height: 300px;">
                        <canvas id="packageRevenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const revenueData = {
        '7days': { labels: @Html.Raw(Json.Serialize(Model.RevenueLabels7Days)), data: @Html.Raw(Json.Serialize(Model.RevenueValues7Days)), prev: @Html.Raw(Json.Serialize(Model.RevenueValues7DaysPrev)) },
        '30days': { labels: @Html.Raw(Json.Serialize(Model.RevenueLabels30Days)), data: @Html.Raw(Json.Serialize(Model.RevenueValues30Days)), prev: @Html.Raw(Json.Serialize(Model.RevenueValues30DaysPrev)) },
        '1year': { labels: @Html.Raw(Json.Serialize(Model.RevenueLabels1Year)), data: @Html.Raw(Json.Serialize(Model.RevenueValues1Year)), prev: @Html.Raw(Json.Serialize(Model.RevenueValues1YearPrev)) }
    };

    let revenueChartInstance = null;
    let currentRange = '1year';

    function updateRevenueChart(range, btn) {
        if(btn) { document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        currentRange = range;
        const newData = revenueData[range];

        const container = document.querySelector('.chart-area-container');
        container.style.width = newData.labels.length > 7 ? `${(newData.labels.length/7)*100}%` : '100%';

        if (revenueChartInstance) {
            revenueChartInstance.data.labels = newData.labels;
            revenueChartInstance.data.datasets[0].data = newData.data;
            revenueChartInstance.update();
            revenueChartInstance.resize();
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var ctxRevenue = document.getElementById("revenueChart");
        if (ctxRevenue) {
            const initial = revenueData['1year'];
            document.querySelector('.chart-area-container').style.width = `${(initial.labels.length/7)*100}%`;

            revenueChartInstance = new Chart(ctxRevenue, {
                type: 'line',
                data: {
                    labels: initial.labels,
                    datasets: [{
                        label: "Revenue", data: initial.data, fill: false,
                        borderColor: 'rgb(75, 192, 192)', tension: 0.1, pointRadius: 5, borderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', axis: 'x', intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    const prev = revenueData[currentRange].prev[context.dataIndex];
                                    let lines = [`Revenue: RM ${val}`];
                                    if(prev > 0) {
                                        const pct = ((val - prev) / prev) * 100;
                                        lines.push(`${pct >= 0 ? '+' : ''}${pct.toFixed(1)}% vs prev`);
                                    }
                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        var ctxPkg = document.getElementById("packageRevenueChart");
        if (ctxPkg) {
            new Chart(ctxPkg, {
                type: 'doughnut',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.PackageRevenueLabels)),
                    datasets: [{
                        data: @Html.Raw(Json.Serialize(Model.PackageRevenueValues)),
                        backgroundColor: ['#fa938e', '#98bf45', '#51cbcf', '#d397ff', '#4e73df']
                    }]
                },
                options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }
    });
</script>