@model FlyEase.ViewModels.FeedbackAnalyticsViewModel

@{
    ViewData["Title"] = "Feedback Analytics";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* Dark Mode Support */
    .card {
        background-color: var(--bg-card) !important;
        border: 1px solid var(--border-color);
    }

    h2, h5, h6, .display-4, th, td, small, .text-muted {
        color: var(--text-main) !important;
    }

    [data-bs-theme="dark"] .text-muted {
        color: #adb5bd !important;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,0.05);
    }

    [data-bs-theme="dark"] .table-light {
        background-color: #2c3034;
        color: #fff;
    }

    [data-bs-theme="dark"] .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.2) !important;
        color: #75b798 !important;
    }

    [data-bs-theme="dark"] .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.2) !important;
        color: #ea868f !important;
    }
</style>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0">Analytics Overview</h2>
            <p class="text-muted small mb-0">Detailed performance metrics and customer insights.</p>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm border-start border-warning border-4">
                <div class="card-body text-center d-flex flex-column justify-content-center py-4">
                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Overall Rating</h6>
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="display-4 fw-bold me-2">@Model.AverageRating.ToString("0.0")</span>
                        <div class="text-start">
                            <div class="text-warning small"><i class="fas fa-star"></i></div>
                            <div class="text-muted small" style="font-size: 0.7rem;">/ 5.0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm border-start border-info border-4">
                <div class="card-body text-center d-flex flex-column justify-content-center py-4">
                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Total Reviews</h6>
                    <div class="display-4 fw-bold text-info">@Model.TotalReviews</div>
                    <small class="text-muted">Verified Feedback</small>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm border-start border-success border-4">
                <div class="card-body text-center d-flex flex-column justify-content-center py-4">
                    <h6 class="text-uppercase text-muted small fw-bold mb-2">Positive Sentiment</h6>
                    <div class="display-4 fw-bold text-success">@Model.PositivePercentage.ToString("0")%</div>
                    <small class="text-muted">Based on 4 & 5 star ratings</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-3">
                    <h6 class="fw-bold mb-0"><i class="fas fa-tags me-2 text-primary"></i>Feedback Categories</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th>Avg Rating</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cat in Model.CategoryRatings)
                                {
                                    <tr>
                                        <td><span class="badge bg-light text-dark border">@cat.Key</span></td>
                                        <td>
                                            @cat.Value.ToString("0.0")
                                            <i class="fas fa-star text-warning small"></i>
                                        </td>
                                        <td>
                                            @if (Model.CategoryCounts.ContainsKey(cat.Key))
                                            {
                                                @Model.CategoryCounts[cat.Key]
                                            }
                                        </td>
                                    </tr>
                                }
                                @if (!Model.CategoryRatings.Any())
                                {
                                    <tr><td colspan="3" class="text-center text-muted">No data available.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0"><i class="fas fa-user-clock me-2 text-warning"></i>Users Who Haven't Rated</h6>
                    <span class="badge bg-warning text-dark">@Model.UnratedCount Pending</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">User</th>
                                    <th>Package</th>
                                    <th class="text-end pe-4">Trip Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Model.UnratedBookings)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <div class="fw-bold">@booking.User.FullName</div>
                                            <small class="text-muted">@booking.User.Email</small>
                                        </td>
                                        <td>@booking.Package.PackageName</td>
                                        <td class="text-end pe-4 text-muted small">
                                            @booking.TravelDate.ToString("dd MMM")
                                        </td>
                                    </tr>
                                }
                                @if (!Model.UnratedBookings.Any())
                                {
                                    <tr><td colspan="3" class="text-center py-4 text-muted">Everyone has rated their trips! 🎉</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm border-start border-success border-4">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h6 class="text-uppercase text-success small fw-bold mb-0">🏆 Top Performer</h6>
                        <span class="badge bg-success-subtle text-success">Best Rated</span>
                    </div>
                    @if (Model.MostPopularPackage != null)
                    {
                        <h5 class="fw-bold mb-1">@Model.MostPopularPackage.PackageName</h5>
                        <div class="d-flex align-items-center mt-2">
                            <span class="fw-bold text-success me-2">@Model.MostPopularPackage.AverageRating.ToString("0.0") ★</span>
                            <span class="text-muted small">(@Model.MostPopularPackage.ReviewCount reviews)</span>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small fst-italic">No data yet.</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm border-start border-danger border-4">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h6 class="text-uppercase text-danger small fw-bold mb-0">📉 Needs Improvement</h6>
                        <span class="badge bg-danger-subtle text-danger">Lowest Rated</span>
                    </div>
                    @if (Model.LeastPopularPackage != null)
                    {
                        <h5 class="fw-bold mb-1">@Model.LeastPopularPackage.PackageName</h5>
                        <div class="d-flex align-items-center mt-2">
                            <span class="fw-bold text-danger me-2">@Model.LeastPopularPackage.AverageRating.ToString("0.0") ★</span>
                            <span class="text-muted small">(@Model.LeastPopularPackage.ReviewCount reviews)</span>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small fst-italic">No data yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 py-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Rating Distribution</h6>
        </div>
        <div class="card-body">
            <div style="height: 350px; width: 100%;">
                <canvas id="feedbackChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-5">
        <div class="card-header bg-transparent border-0 py-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-comments me-2 text-primary"></i>Recent Customer Feedback</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Customer</th>
                            <th>Package</th>
                            <th style="width: 15%;">Rating</th>
                            <th style="width: 35%;">Comment</th>
                            <th class="text-end pe-4">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.RecentReviews)
                        {
                            <tr>
                                <td class="ps-4 fw-bold">@(item.User?.FullName ?? "Anonymous")</td>
                                <td>@(item.Booking?.Package?.PackageName ?? "Unknown Package")</td>
                                <td>
                                    @for (int i = 0; i < item.Rating; i++)
                                    {
                                        <i class="fas fa-star text-warning" style="font-size: 0.8rem;"></i>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.Comment))
                                    {
                                        <span class="text-muted">"@item.Comment"</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small fst-italic">No comment provided</span>
                                    }
                                </td>
                                <td class="text-end pe-4 text-muted small">@item.CreatedDate.ToString("MMM dd, yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let myChart = null;
        function getCssVar(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
        function initChart() {
            const ctx = document.getElementById('feedbackChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const textColor = getCssVar('--text-muted') || (isDark ? '#adb5bd' : '#6c757d');
            const gridColor = getCssVar('--border-color') || (isDark ? '#373b3e' : '#f0f0f0');

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                    datasets: [{
                        label: 'Number of Reviews',
                        data: [
                            @((Model.RatingCounts != null && Model.RatingCounts.ContainsKey(5)) ? Model.RatingCounts[5] : 0),
                            @((Model.RatingCounts != null && Model.RatingCounts.ContainsKey(4)) ? Model.RatingCounts[4] : 0),
                            @((Model.RatingCounts != null && Model.RatingCounts.ContainsKey(3)) ? Model.RatingCounts[3] : 0),
                            @((Model.RatingCounts != null && Model.RatingCounts.ContainsKey(2)) ? Model.RatingCounts[2] : 0),
                            @((Model.RatingCounts != null && Model.RatingCounts.ContainsKey(1)) ? Model.RatingCounts[1] : 0)
                        ],
                        backgroundColor: ['#198754', '#20c997', '#ffc107', '#fd7e14', '#dc3545'],
                        borderRadius: 4, barPercentage: 0.65
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: gridColor, drawBorder: false }, ticks: { stepSize: 1, color: textColor } },
                        y: { grid: { display: false }, ticks: { font: { size: 13, weight: '600' }, color: textColor } }
                    }
                }
            });
        }
        document.addEventListener("DOMContentLoaded", initChart);
        new MutationObserver((mutations) => { mutations.forEach((m) => { if (m.attributeName === 'data-bs-theme') initChart(); }); }).observe(document.documentElement, { attributes: true });
    </script>
}