@using X.PagedList
@using X.PagedList.Mvc.Core
@model FlyEase.ViewModels.PackagesPageVM

@{
    ViewData["Title"] = "Manage Packages";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
    /* Gallery Styles for Image Management */
    .image-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .gallery-item {
        position: relative;
        width: 100px;
        height: 100px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        cursor: grab;
        background: #f9f9f9;
    }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
        }

        .gallery-item.deleted {
            opacity: 0.4;
            filter: grayscale(100%);
            border: 2px solid red;
        }

    .sortable-ghost {
        opacity: 0.4;
        background-color: #c8ebfb;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold"><i class="fas fa-box-open me-2"></i>Package Management</h2>
    <button class="btn btn-primary" onclick="openPackageModal()">
        <i class="fas fa-plus me-2"></i>Create New Package
    </button>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body py-3">
        <form method="get" asp-action="Packages" class="row g-3">
            <div class="col-md-10">
                <input type="text" name="search" class="form-control" placeholder="Search by Package Name..." value="@Model.SearchTerm">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary w-100">Search</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm align-middle mb-0" style="font-size: 0.9rem;">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Slots</th>
                        <th>Rating</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Packages != null && Model.Packages.Any())
                    {
                        foreach (var p in Model.Packages)
                        {
                            var firstImage = !string.IsNullOrEmpty(p.ImageURL) ? p.ImageURL.Split(';', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() : "/img/default-package.jpg";
                            <tr>
                                <td class="ps-4">#@p.PackageID</td>
                                <td>
                                    <img src="@firstImage" alt="pkg" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" />
                                </td>
                                <td class="fw-bold">@p.PackageName</td>
                                <td>@p.Category?.CategoryName</td>
                                <td class="text-success fw-bold">RM @p.Price.ToString("N2")</td>
                                <td>
                                    @if (p.AvailableSlots < 5)
                                    {
                                        <span class="text-danger fw-bold">@p.AvailableSlots left</span>
                                    }
                                    else
                                    {
                                        <span>@p.AvailableSlots</span>
                                    }
                                </td>
                                <td>
                                    <span class="text-warning"><i class="fas fa-star"></i></span> @p.AverageRating.ToString("0.0")
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-1"
                                            onclick="editPackage(@p.PackageID, '@System.Web.HttpUtility.JavaScriptStringEncode(p.PackageName)', @p.CategoryID, @p.Price, @p.AvailableSlots, '@System.Web.HttpUtility.JavaScriptStringEncode(p.Destination)', '@System.Web.HttpUtility.JavaScriptStringEncode(p.Description)', '@p.StartDate.ToString("yyyy-MM-dd")', '@p.EndDate.ToString("yyyy-MM-dd")', @p.Latitude, @p.Longitude, '@System.Web.HttpUtility.JavaScriptStringEncode(p.ImageURL)')">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="initiateDelete(@p.PackageID, @(p.Bookings?.Count ?? 0))">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="8" class="text-center py-4 text-muted">No packages found.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="card-footer bg-white py-3">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Page @(Model.Packages.PageCount < Model.Packages.PageNumber ? 0 : Model.Packages.PageNumber) of @Model.Packages.PageCount
            </small>
            @Html.PagedListPager(Model.Packages, page => Url.Action("Packages", new { page, search = Model.SearchTerm }),
            new PagedListRenderOptions
            {
                LiElementClasses = new string[] { "page-item" },
                PageClasses = new string[] { "page-link" },
                UlElementClasses = new string[] { "pagination", "pagination-sm", "mb-0" }
            })
        </div>
    </div>
</div>

<div class="modal fade" id="packageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="pkgForm" asp-action="SavePackage" method="post" enctype="multipart/form-data" onsubmit="submitPackageForm(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="pkgModalLabel">Add Package</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="pkgId" name="CurrentPackage.PackageID" value="0" />

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Package Name</label>
                            <input type="text" class="form-control" id="pkgName" name="CurrentPackage.PackageName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="pkgCat" name="CurrentPackage.CategoryID" required>
                                @foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryID">@cat.CategoryName</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Destination</label>
                            <input type="text" class="form-control" id="pkgDest" name="CurrentPackage.Destination" required />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" id="pkgPrice" name="CurrentPackage.Price" required />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Slots</label>
                            <input type="number" class="form-control" id="pkgSlots" name="CurrentPackage.AvailableSlots" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="pkgStart" name="CurrentPackage.StartDate" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="pkgEnd" name="CurrentPackage.EndDate" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Latitude</label>
                            <input type="text" class="form-control" id="pkgLat" name="CurrentPackage.Latitude" value="3.1390" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Longitude</label>
                            <input type="text" class="form-control" id="pkgLong" name="CurrentPackage.Longitude" value="101.6869" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="pkgDesc" name="CurrentPackage.Description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Package Images</label>
                        <div class="input-group">
                            <input class="form-control" name="CurrentPackage.ImageFiles" id="imageInput" type="file" accept="image/*" multiple onchange="handleFileSelect(this)" />
                            <button type="button" class="btn btn-outline-danger" id="clearNewBtn" style="display:none;" onclick="clearNewUploads()">Clear All</button>
                        </div>

                        <div class="mt-3" id="previewContainer" style="display:none; border: 1px dashed #28a745; padding: 10px; border-radius: 8px;">
                            <label class="small fw-bold text-success">New Images (Drag to Reorder):</label>
                            <div class="image-gallery" id="newImagesGallery"></div>
                        </div>

                        <div id="existingImagesWrapper" style="display:none;" class="mt-3">
                            <label class="small fw-bold text-primary">Saved Images (Drag to Reorder):</label>
                            <div class="image-gallery" id="existingImagesGallery"></div>
                        </div>

                        <div id="deletedImagesContainer"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Package</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" asp-action="DeletePackage" method="post" style="display:none;">
    <input type="hidden" name="id" id="deletePackageId" />
</form>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteModalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="finalDeleteBtn" onclick="submitDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    let uploadedFiles = [];
    let newImagesSortable = null;
    let existingImagesSortable = null;
    let deleteTimer = null;

    // --- DELETION LOGIC ---
    function initiateDelete(pkgId, bookingCount) {
        // 1. Set ID
        document.getElementById('deletePackageId').value = pkgId;

        // 2. Setup Modal
        const modalEl = document.getElementById('deleteConfirmModal');
        const modal = new bootstrap.Modal(modalEl);
        const contentDiv = document.getElementById('deleteModalContent');
        const btn = document.getElementById('finalDeleteBtn');

        // 3. Reset Button
        if (deleteTimer) clearInterval(deleteTimer);
        btn.disabled = false;
        btn.innerText = "Delete";
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-danger');

        if (bookingCount > 0) {
            // CASE: Existing Bookings (Wait 3 seconds)
            contentDiv.innerHTML = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    <strong>Warning:</strong> This package has <strong>${bookingCount} existing booking(s)</strong>.
                </div>
                <p class="mb-0">Deleting this package will <strong>permanently cancel/remove</strong> all associated bookings.</p>
                <p class="text-muted small mt-2">Please wait 3 seconds to confirm this action.</p>
            `;

            btn.disabled = true;
            let timeLeft = 3;
            btn.innerText = `Wait ${timeLeft}s...`;

            deleteTimer = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(deleteTimer);
                    btn.disabled = false;
                    btn.innerText = "Yes, Delete Everything";
                } else {
                    btn.innerText = `Wait ${timeLeft}s...`;
                }
            }, 1000);
        } else {
            // CASE: No Bookings
            contentDiv.innerHTML = `<p>Are you sure you want to delete this package? This action cannot be undone.</p>`;
        }

        modal.show();
    }

    function submitDelete() {
        document.getElementById('deleteForm').submit();
    }

    // --- EXISTING IMAGE & UPLOAD LOGIC ---
    function handleFileSelect(input) {
        if (input.files && input.files.length > 0) {
            Array.from(input.files).forEach(file => { uploadedFiles.push(file); });
            renderNewImages();
            input.value = '';
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('clearNewBtn').style.display = 'block';
        }
    }

    function renderNewImages() {
        const gallery = document.getElementById('newImagesGallery');
        gallery.innerHTML = '';
        uploadedFiles.forEach((file, index) => {
            const reader = new FileReader();
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.setAttribute('data-index', index);
            reader.onload = function (e) {
                div.innerHTML = `<img src="${e.target.result}" /><span class="remove-btn" onclick="removeNewFile(${index})">&times;</span>`;
            }
            reader.readAsDataURL(file);
            gallery.appendChild(div);
        });

        if (newImagesSortable) newImagesSortable.destroy();
        newImagesSortable = new Sortable(gallery, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const newOrder = [];
                const items = gallery.querySelectorAll('.gallery-item');
                items.forEach(item => {
                    newOrder.push(uploadedFiles[parseInt(item.getAttribute('data-index'))]);
                });
                uploadedFiles = newOrder;
                renderNewImages();
            }
        });
    }

    function removeNewFile(index) {
        uploadedFiles.splice(index, 1);
        renderNewImages();
        if (uploadedFiles.length === 0) {
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('clearNewBtn').style.display = 'none';
        }
    }

    function clearNewUploads() {
        uploadedFiles = [];
        renderNewImages();
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('clearNewBtn').style.display = 'none';
    }

    function toggleDeletion(path, elementId) {
        const element = document.getElementById(elementId);
        if (element.classList.contains('deleted')) {
            element.classList.remove('deleted');
            const input = document.querySelector(`input[name="DeleteImagePaths"][value="${path}"]`);
            if (input) input.remove();
        } else {
            element.classList.add('deleted');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'DeleteImagePaths';
            input.value = path;
            document.getElementById('deletedImagesContainer').appendChild(input);
        }
    }

    function stringHashCode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = (hash << 5) - hash + str.charCodeAt(i);
            hash |= 0;
        }
        return hash;
    }

    function openPackageModal() {
        document.getElementById('pkgId').value = 0;
        document.getElementById('pkgName').value = '';
        document.getElementById('pkgDest').value = '';
        document.getElementById('pkgPrice').value = '';
        document.getElementById('pkgSlots').value = '';
        document.getElementById('pkgDesc').value = '';
        document.getElementById('pkgStart').value = '';
        document.getElementById('pkgEnd').value = '';
        document.getElementById('pkgModalLabel').innerText = 'Create New Package';

        uploadedFiles = [];
        document.getElementById('newImagesGallery').innerHTML = '';
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('clearNewBtn').style.display = 'none';
        document.getElementById('existingImagesWrapper').style.display = 'none';
        document.getElementById('existingImagesGallery').innerHTML = '';
        document.getElementById('deletedImagesContainer').innerHTML = '';

        var modal = new bootstrap.Modal(document.getElementById('packageModal'));
        modal.show();
    }

    function editPackage(id, name, catId, price, slots, dest, desc, start, end, lat, long, imageUrl) {
        document.getElementById('pkgId').value = id;
        document.getElementById('pkgName').value = name;
        document.getElementById('pkgCat').value = catId;
        document.getElementById('pkgPrice').value = price;
        document.getElementById('pkgSlots').value = slots;
        document.getElementById('pkgDest').value = dest;
        document.getElementById('pkgDesc').value = desc;
        document.getElementById('pkgStart').value = start;
        document.getElementById('pkgEnd').value = end;
        document.getElementById('pkgLat').value = lat;
        document.getElementById('pkgLong').value = long;
        document.getElementById('pkgModalLabel').innerText = 'Edit Package';

        uploadedFiles = [];
        document.getElementById('newImagesGallery').innerHTML = '';
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('clearNewBtn').style.display = 'none';
        document.getElementById('deletedImagesContainer').innerHTML = '';

        const gallery = document.getElementById('existingImagesGallery');
        const wrapper = document.getElementById('existingImagesWrapper');
        gallery.innerHTML = '';

        if (imageUrl && imageUrl.trim() !== "") {
            const images = imageUrl.split(';');
            wrapper.style.display = 'block';
            images.forEach(img => {
                if (img.trim() === "") return;
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.id = "img-" + Math.abs(stringHashCode(img));
                div.innerHTML = `<img src="${img}" data-server-path="${img}" /><span class="remove-btn" onclick="toggleDeletion('${img}', '${div.id}')" title="Delete">&times;</span>`;
                gallery.appendChild(div);
            });

            if (existingImagesSortable) existingImagesSortable.destroy();
            existingImagesSortable = new Sortable(gallery, {
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
        } else {
            wrapper.style.display = 'none';
        }

        var modal = new bootstrap.Modal(document.getElementById('packageModal'));
        modal.show();
    }

    async function submitPackageForm(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        const formData = new FormData(form);
        formData.delete('CurrentPackage.ImageFiles');

        uploadedFiles.forEach(file => {
            formData.append('CurrentPackage.ImageFiles', file);
        });

        const existingImgs = Array.from(document.querySelectorAll('#existingImagesGallery .gallery-item:not(.deleted) img'))
            .map(img => img.getAttribute('data-server-path'));

        if (existingImgs.length > 0) {
            formData.append('OrderedExistingImages', existingImgs.join(','));
        }

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            if (response.ok || response.redirected) {
                window.location.reload();
            } else {
                alert("Failed to save package. Please try again.");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        } catch (error) {
            console.error(error);
            alert("An error occurred.");
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
</script>