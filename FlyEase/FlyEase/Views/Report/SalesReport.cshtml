@model FlyEase.ViewModels.SalesReportVM
@{
    ViewData["Title"] = "Vendor Sales Report";
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
}

    <link rel="stylesheet" href="~/css/report.css" />


<div class="container-fluid py-4 report-dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Sales Report</h2>
            <p class="text-muted small">Detailed transactional ledger</p>
        </div>
        <div>
             <a href="@Url.Action("ExportSalesExcel", Context.Request.Query)" class="btn btn-success btn-sm">
                <i class="fas fa-file-excel me-1"></i> Export Excel
            </a>
            
            <a href="@Url.Action("SalesReportPrinted", Context.Request.Query)" target="_blank" class="btn btn-secondary btn-sm">
                <i class="fas fa-print me-1"></i> Generate / PDF
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body bg-light">
            <form method="GET" action="@Url.Action("SalesReport")">
                <input type="hidden" name="page" value="1" />
                
                <div class="quick-filter-wrapper">
                    <span class="filter-label">Quick View:</span>
                    <button type="submit" name="viewMode" value="daily" class="preset-btn @(Model.ViewMode == "daily" ? "active" : "")">Today</button>
                    <button type="submit" name="viewMode" value="monthly" class="preset-btn @(Model.ViewMode == "monthly" ? "active" : "")">This Month</button>
                    <button type="submit" name="viewMode" value="custom" class="preset-btn @(Model.ViewMode == "custom" ? "active" : "")">Custom</button>
                </div>

                <div class="row g-3 align-items-end mt-2">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">From</label>
                        <input type="date" name="startDate" class="form-control form-control-sm" value="@Model.StartDate.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">To</label>
                        <input type="date" name="endDate" class="form-control form-control-sm" value="@Model.EndDate.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Filter Item (Package)</label>
                        <select name="packageId" class="form-select form-select-sm">
                            <option value="">All Items</option>
                            @foreach(var pkg in Model.AvailablePackages)
                            {
                                <option value="@pkg.Id" selected="@(Model.SelectedPackageID == pkg.Id)">@pkg.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Search</label>
                        <input type="text" name="search" class="form-control form-control-sm" placeholder="Customer or Package Name..." value="@Model.SearchTerm">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Filter Records</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 report-table">
                <thead class="table-light text-uppercase small fw-bold">
                    <tr>
                        <th>Date</th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product / Package</th>
                        <th class="text-end">Qty</th>
                        <th class="text-end">Subtotal (RM)</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Details.Any())
                    {
                        foreach (var item in Model.Details)
                        {
                            <tr>
                                <td>@item.BookingDate.ToString("dd/MM/yyyy")</td>
                                <td class="text-primary fw-bold">@item.TransactionID</td>
                                <td>@item.CustomerName</td>
                                <td>@item.PackageName</td>
                                <td class="text-end">@item.Pax</td>
                                <td class="text-end">@item.Amount.ToString("N2")</td>
                            </tr>
                        }
                        <tr class="table-footer">
                            <td colspan="4" class="text-end">GRAND TOTAL</td>
                            <td class="text-end">@Model.GrandTotalPax</td>
                            <td class="text-end">RM @Model.GrandTotalRevenue.ToString("N2")</td>
                        </tr>
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-search fa-2x mb-3 opacity-50"></i>
                                <p class="mb-0">No records found matching your filters.</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="pagination-container">
            @{
                var queryParams = Context.Request.Query.ToDictionary(k => k.Key, v => v.Value.ToString());
                queryParams["page"] = (Model.CurrentPage - 1).ToString();
                var prevLink = Url.Action("SalesReport", queryParams);
                
                queryParams["page"] = (Model.CurrentPage + 1).ToString();
                var nextLink = Url.Action("SalesReport", queryParams);
            }
            
            <a href="@prevLink" class="page-link-custom @(!Model.HasPreviousPage ? "disabled" : "")">&larr; Prev</a>
            <span class="page-info">Page @Model.CurrentPage of @Model.TotalPages</span>
            <a href="@nextLink" class="page-link-custom @(!Model.HasNextPage ? "disabled" : "")">Next &rarr;</a>
        </div>
    }
</div>