@model FlyEase.ViewModels.PackagePerformanceReportVM
@{
    ViewData["Title"] = "Package Performance";
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
    <div>
        <h2 class="mb-0 text-primary">Package Performance</h2>
        <p class="text-muted small mb-0">Analysis by Revenue or Sales Volume.</p>
    </div> 

</div>

<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
        <form method="GET" id="reportForm">

            <input type="hidden" name="page" value="1" />
           
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <span class="align-self-center text-muted small fw-bold text-uppercase me-2">Quick View:</span>
                    <button type="submit" formaction="@Url.Action("PackagePerformanceReport")" name="viewMode" value="daily" class="preset-btn @(Model.ViewMode == "daily" ? "active" : "")">Today</button>
                    <button type="submit" formaction="@Url.Action("PackagePerformanceReport")" name="viewMode" value="monthly" class="preset-btn @(Model.ViewMode == "monthly" ? "active" : "")">This Month</button>
                    <button type="submit" formaction="@Url.Action("PackagePerformanceReport")" name="viewMode" value="custom" class="preset-btn @(Model.ViewMode == "custom" ? "active" : "")">Custom</button>
                </div>
                <div class="btn-group">
                    <button type="submit" formaction="@Url.Action("ExportPackageExcel")" class="btn btn-success btn-sm shadow-sm">
                        <i class="fas fa-file-excel me-1"></i> Export Excel
                    </button>
                    <button type="submit" formaction="@Url.Action("PackagePerformancePrinted")" formtarget="_blank" class="btn btn-secondary btn-sm shadow-sm">
                        <i class="fas fa-print me-1"></i> Generate / PDF
                    </button>
                </div>
            </div> 
            

            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">From</label>
                    <input type="date" name="startDate" class="form-control form-control-sm" value="@Model.StartDate.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">To</label>
                    <input type="date" name="endDate" class="form-control form-control-sm" value="@Model.EndDate.ToString("yyyy-MM-dd")">
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Category</label>
                    <select name="category" class="form-select form-select-sm">
                        @foreach (var cat in Model.AvailableCategories)
                        {
                            <option value="@cat" selected="@(Model.CategoryFilter == cat ? "selected" : null)">@cat</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Specific Package</label>
                    <select name="packageId" class="form-select form-select-sm">
                        <option value="">All Packages</option>
                        @foreach (var pkg in Model.AvailablePackages)
                        {
                            <option value="@pkg.Id" selected="@(Model.PackageFilter == pkg.Id ? "selected" : null)">@pkg.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Sort By</label>
                    <select name="sortBy" class="form-select form-select-sm fw-bold text-primary">
                        <option value="Revenue" selected="@(Model.SortBy == "Revenue" ? "selected" : null)">Highest Revenue</option>
                        <option value="Volume" selected="@(Model.SortBy == "Volume" ? "selected" : null)">Most Sold (Pax)</option>
                    </select>
                </div>

                <div class="col-md-1">
                    <button type="submit" formaction="@Url.Action("PackagePerformanceReport")" class="btn btn-primary btn-sm w-100 shadow-sm">
                        <i class="fas fa-search"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 report-table">
            <thead class="bg-light text-uppercase small fw-bold text-muted">
                <tr>
                    <th class="ps-4">Rank</th>
                    <th>Package Name</th>
                    <th>Category</th>
                    <th class="text-end">Price</th>
                    <th class="text-end">Bookings</th>
                    <th class="text-end @(Model.SortBy == "Volume" ? "bg-warning bg-opacity-10 text-dark fw-bold" : "")">Pax Sold</th>
                    <th class="text-end pe-4 @(Model.SortBy == "Revenue" ? "bg-success bg-opacity-10 text-success fw-bold" : "")">Revenue (RM)</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Details.Any())
                {
                    int rank = (Model.CurrentPage - 1) * Model.PageSize + 1;
                    foreach (var item in Model.Details)
                    {
                        <tr>
                            <td class="ps-4 text-muted small">#@rank</td>
                            <td class="fw-bold text-dark">@item.PackageName</td>
                            <td><span class="badge bg-light text-dark border">@item.Category</span></td>
                            <td class="text-end">@item.Price.ToString("N2")</td>
                            <td class="text-end">@item.TotalBookings</td>
                            <td class="text-end @(Model.SortBy == "Volume" ? "fw-bold text-dark bg-warning bg-opacity-10" : "")">@item.TotalPax</td>
                            <td class="text-end pe-4 @(Model.SortBy == "Revenue" ? "fw-bold text-success bg-success bg-opacity-10" : "")">@item.Revenue.ToString("N2")</td>
                        </tr>
                        rank++;
                    }
                    <tr class="table-footer">
                        <td colspan="5" class="text-end text-uppercase small">Grand Total</td>
                        <td class="text-end">@Model.TotalPackagesSold</td>
                        <td class="text-end pe-4">RM @Model.TotalRevenue.ToString("N2")</td>
                    </tr>
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="fas fa-box-open fa-3x mb-3 opacity-25"></i>
                            <p class="mb-0">No active packages found for this period.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (Model.TotalPages > 1)
{
    <div class="pagination-container mt-4">
        @{
            var queryParams = Context.Request.Query.ToDictionary(k => k.Key, v => v.Value.ToString());
            queryParams["page"] = (Model.CurrentPage - 1).ToString();
            var prevLink = Url.Action("PackagePerformanceReport", queryParams);
            queryParams["page"] = (Model.CurrentPage + 1).ToString();
            var nextLink = Url.Action("PackagePerformanceReport", queryParams);
        }
        <a href="@prevLink" class="page-link-custom shadow-sm @(!Model.HasPreviousPage ? "disabled" : "")"><i class="fas fa-chevron-left"></i></a>
        <span class="page-info mx-3">Page @Model.CurrentPage of @Model.TotalPages</span>
        <a href="@nextLink" class="page-link-custom shadow-sm @(!Model.HasNextPage ? "disabled" : "")"><i class="fas fa-chevron-right"></i></a>
    </div>
}