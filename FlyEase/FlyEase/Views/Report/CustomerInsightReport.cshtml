@model FlyEase.ViewModels.CustomerInsightReportVM
@{
    ViewData["Title"] = "Customer Insights";
    Layout = "~/Views/Shared/_ReportLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
    <div>
        <h2 class="mb-0 text-primary">Customer Insights</h2>
        <p class="text-muted small mb-0">Analyze customer spending behavior and loyalty.</p>
    </div>
</div>

<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
        <form method="GET" id="reportForm">
            <input type="hidden" name="page" value="1" />

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <span class="align-self-center text-muted small fw-bold text-uppercase me-2">Quick View:</span>
                    <button type="submit" formaction="@Url.Action("CustomerInsightReport")" name="viewMode" value="daily" class="preset-btn @(Model.ViewMode == "daily" ? "active" : "")">Today</button>
                    <button type="submit" formaction="@Url.Action("CustomerInsightReport")" name="viewMode" value="monthly" class="preset-btn @(Model.ViewMode == "monthly" ? "active" : "")">This Month</button>
                    <button type="submit" formaction="@Url.Action("CustomerInsightReport")" name="viewMode" value="custom" class="preset-btn @(Model.ViewMode == "custom" ? "active" : "")">Custom</button>
                </div>

                <div class="btn-group">
                    <button type="submit" formaction="@Url.Action("ExportCustomerExcel")" class="btn btn-success btn-sm shadow-sm">
                        <i class="fas fa-file-excel me-1"></i> Export Excel
                    </button>
                    <button type="submit" formaction="@Url.Action("CustomerInsightPrinted")" formtarget="_blank" class="btn btn-secondary btn-sm shadow-sm">
                        <i class="fas fa-print me-1"></i> Generate / PDF
                    </button>
                </div>
            </div>

            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">From</label>
                    <input type="date" name="startDate" class="form-control form-control-sm" value="@Model.StartDate.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">To</label>
                    <input type="date" name="endDate" class="form-control form-control-sm" value="@Model.EndDate.ToString("yyyy-MM-dd")">
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Search Customer</label>
                    <input type="text" name="search" class="form-control form-control-sm" placeholder="Name or Email..." value="@Model.SearchTerm">
                </div>

                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Sort By</label>
                    <select name="sortBy" class="form-select form-select-sm fw-bold text-primary">
                        <option value="Spending" selected="@(Model.SortBy == "Spending" ? "selected" : null)">Highest Spending</option>
                        <option value="Frequency" selected="@(Model.SortBy == "Frequency" ? "selected" : null)">Most Frequent (Bookings)</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="submit" formaction="@Url.Action("CustomerInsightReport")" class="btn btn-primary btn-sm w-100 shadow-sm">
                        <i class="fas fa-search me-1"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 report-table">
            <thead class="bg-light text-uppercase small fw-bold text-muted">
                <tr>
                    <th class="ps-4">Rank</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th class="text-end">Last Booking</th>
                    <th class="text-end @(Model.SortBy == "Frequency" ? "bg-warning bg-opacity-10 text-dark fw-bold" : "")">Bookings</th>
                    <th class="text-end pe-4 @(Model.SortBy == "Spending" ? "bg-success bg-opacity-10 text-success fw-bold" : "")">Total Spent (RM)</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Details.Any())
                {
                    int rank = (Model.CurrentPage - 1) * Model.PageSize + 1;
                    foreach (var item in Model.Details)
                    {
                        <tr>
                            <td class="ps-4 text-muted small">#@rank</td>
                            <td class="fw-bold text-dark">@item.CustomerName</td>
                            <td class="small text-muted">@item.Email</td>
                            <td class="text-end text-muted small">@(item.LastBookingDate.HasValue? item.LastBookingDate.Value.ToString("dd MMM yyyy") : "-")</td>

                            <td class="text-end @(Model.SortBy == "Frequency" ? "fw-bold text-dark bg-warning bg-opacity-10" : "")">
                                @item.TotalBookings
                            </td>
                            <td class="text-end pe-4 @(Model.SortBy == "Spending" ? "fw-bold text-success bg-success bg-opacity-10" : "")">
                                @item.TotalSpent.ToString("N2")
                            </td>
                        </tr>
                        rank++;
                    }
                    <tr class="table-footer">
                        <td colspan="4" class="text-end text-uppercase small">Grand Total</td>
                        <td class="text-end">@Model.TotalBookings</td>
                        <td class="text-end pe-4">RM @Model.TotalRevenue.ToString("N2")</td>
                    </tr>
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="fas fa-users-slash fa-3x mb-3 opacity-25"></i>
                            <p class="mb-0">No customer records found for this period.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (Model.TotalPages > 1)
{
    <div class="pagination-container mt-4">
        @{
            var queryParams = Context.Request.Query.ToDictionary(k => k.Key, v => v.Value.ToString());
            queryParams["page"] = (Model.CurrentPage - 1).ToString();
            var prevLink = Url.Action("CustomerInsightReport", queryParams);
            queryParams["page"] = (Model.CurrentPage + 1).ToString();
            var nextLink = Url.Action("CustomerInsightReport", queryParams);
        }
        <a href="@prevLink" class="page-link-custom shadow-sm @(!Model.HasPreviousPage ? "disabled" : "")"><i class="fas fa-chevron-left"></i></a>
        <span class="page-info mx-3">Page @Model.CurrentPage of @Model.TotalPages</span>
        <a href="@nextLink" class="page-link-custom shadow-sm @(!Model.HasNextPage ? "disabled" : "")"><i class="fas fa-chevron-right"></i></a>
    </div>
}