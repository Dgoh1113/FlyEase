@using FlyEase.ViewModels
@model PackageManagementViewModel

@{
    ViewData["Title"] = " - Package Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/packagemanagement.css" />
<style>
    /* Gallery Styling */
    .image-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .gallery-item {
        position: relative;
        width: 120px;
        height: 120px;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #f9f9f9;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 22px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            z-index: 10;
            transition: all 0.2s;
        }

            .gallery-item .remove-btn:hover {
                background: #cc0000;
                transform: scale(1.1);
            }

        .gallery-item.deleted {
            opacity: 0.5;
            border: 2px dashed red;
            filter: grayscale(100%);
        }

            .gallery-item.deleted::after {
                content: "REMOVED";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: red;
                font-weight: 900;
                font-size: 14px;
                background: rgba(255,255,255,0.8);
                padding: 4px 8px;
                border-radius: 4px;
                pointer-events: none;
            }
</style>

<div class="management-hero">
    <div class="hero-content">
        <h1>Package Management</h1>
        <p>Create, edit, and manage travel packages</p>
    </div>
</div>

<div class="management-container">
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")">
            @Model.Message
        </div>
    }

    <div class="management-grid">
        <!-- FORM COLUMN -->
        <div class="form-card">
            <div class="form-header">
                <h3>@(Model.EditingPackageId == null ? "Create New Package" : "Edit Package")</h3>
            </div>
            <div class="form-body">
                <form method="post"
                      action="@(Model.EditingPackageId == null ? Url.Action("Create") : Url.Action("Update"))"
                      enctype="multipart/form-data" id="packageForm" onsubmit="return validateForm()">
                    @Html.AntiForgeryToken()

                    @if (Model.EditingPackageId.HasValue)
                    {
                        <input type="hidden" name="PackageID" value="@Model.EditingPackageId.Value" />
                    }

                    <!-- BASIC INFO -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Package Name</label>
                            <input class="form-control" name="PackageName" value="@Model.Package.PackageName" required />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="CategoryID" id="categorySelect">
                                <option value="">Select Category or Type New One</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.CategoryID" selected="@(category.CategoryID == Model.SelectedCategoryId)">
                                        @category.CategoryName
                                    </option>
                                }
                            </select>
                            <div class="mt-2" id="newCategoryGroup" style="@(string.IsNullOrWhiteSpace(Model.NewCategoryName) && Model.SelectedCategoryId.HasValue ? "display: none;" : "")">
                                <small class="text-muted">Or enter new category:</small>
                                <input type="text" class="form-control mt-1" name="NewCategoryName" id="newCategoryInput" placeholder="Type new category name" value="@Model.NewCategoryName" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="Description" rows="3">@Model.Package.Description</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Destination</label>
                            <input class="form-control" name="Destination" value="@Model.Package.Destination" required />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input class="form-control" name="Price" type="number" step="0.01" value="@Model.Package.Price" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input class="form-control" name="StartDate" id="startDate" type="date"
                                   value="@(Model.Package.StartDate == default ? "" : Model.Package.StartDate.ToString("yyyy-MM-dd"))"
                                   required onchange="syncItineraryDays()" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input class="form-control" name="EndDate" id="endDate" type="date"
                                   value="@(Model.Package.EndDate == default ? "" : Model.Package.EndDate.ToString("yyyy-MM-dd"))"
                                   required onchange="syncItineraryDays()" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available Slots</label>
                        <input class="form-control" name="AvailableSlots" type="number" value="@(Model.Package.AvailableSlots == 0 ? "" : Model.Package.AvailableSlots.ToString())" required />
                    </div>

                    <!-- IMAGES -->
                    <div class="form-group">
                        <label class="form-label">Package Images</label>
                        <div class="input-group">
                            <input class="form-control" name="ImageFiles" id="imageInput" type="file" accept="image/*" multiple onchange="handleFileSelect(this)" />
                            <button type="button" class="btn btn-outline-danger" id="clearNewBtn" style="display:none;" onclick="clearNewUploads()">Clear All New</button>
                        </div>
                        <div class="mt-3" id="previewContainer" style="display:none; border: 1px dashed #28a745; padding: 10px; border-radius: 8px;">
                            <label class="small fw-bold text-success">New Images (To be uploaded):</label>
                            <div class="image-gallery" id="newImagesGallery"></div>
                        </div>
                        <div id="deletedImagesContainer"></div>
                        @if (Model.EditingPackageId.HasValue && Model.ImageList.Any())
                        {
                            <div class="mt-3">
                                <label class="small fw-bold text-primary">Previously Saved Images:</label>
                                <div class="image-gallery">
                                    @foreach (var imgPath in Model.ImageList)
                                    {
                                        var uniqueId = "img-" + Math.Abs(imgPath.GetHashCode());
                                        <div class="gallery-item" id="@uniqueId">
                                            <img src="@imgPath" onerror="this.src='/img/default-package.jpg'" />
                                            <span class="remove-btn" onclick="toggleDeletion('@imgPath', '@uniqueId')" title="Delete this image">&times;</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- INCLUSIONS -->
                    <div class="form-group">
                        <label class="form-label">Package Inclusions</label>
                        <div id="inclusions-container">
                            @for (int i = 0; i < Model.Inclusions.Count; i++)
                            {
                                <div class="inclusion-item mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="Inclusions[@i]" value="@Model.Inclusions[i]" placeholder="Enter inclusion item" />
                                        <button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button>
                                    </div>
                                </div>
                            }
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addInclusion()">Add Inclusion</button>
                    </div>

                    <hr class="my-4" />

                    <!-- === DAY-BY-DAY ITINERARY === -->
                    <div class="form-group mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0 h5">Itinerary</label>
                            <small class="text-muted">Days will automatically appear based on date selection.</small>
                        </div>

                        <div id="itinerary-container">
                            @if (Model.Itinerary != null && Model.Itinerary.Any())
                            {
                                for (int i = 0; i < Model.Itinerary.Count; i++)
                                {
                                    var day = Model.Itinerary[i];
                                    <div class="card mb-2 p-3 bg-light border itinerary-row" id="day-row-@i">
                                        <div class="d-flex justify-content-between">
                                            <strong>Day <span class="day-label">@day.DayNumber</span></strong>
                                            <button type="button" class="btn btn-sm btn-danger py-0" onclick="removeItineraryRow(this)">&times;</button>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-2">
                                                <input type="number" class="form-control form-control-sm day-input" name="Itinerary[@i].DayNumber" value="@day.DayNumber" readonly />
                                            </div>
                                            <div class="col-md-10">
                                                <!-- Added title-input class and required -->
                                                <input type="text" class="form-control form-control-sm title-input" name="Itinerary[@i].Title" value="@day.Title" placeholder="Title (e.g. Arrival)" required />
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <!-- Added desc-input class and required -->
                                            <textarea class="form-control form-control-sm desc-input" name="Itinerary[@i].ActivityDescription" rows="2" placeholder="Description of activities..." required>@day.ActivityDescription</textarea>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <button type="button" class="btn btn-outline-secondary mt-2 w-100" onclick="addItineraryRow()">+ Add Extra Day</button>
                        <small class="text-danger d-none" id="itineraryError">Every day must have a Title and Description.</small>
                    </div>
                    <!-- ================================= -->

                    <div class="form-actions">
                        @if (Model.EditingPackageId == null)
                        {
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Create Package</button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-warning"><i class="fas fa-save"></i> Update Package</button>
                            <a href="@Url.Action("PackageManagement")" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</a>
                        }
                    </div>
                </form>
            </div>
        </div>

        <!-- LIST COLUMN -->
        <div class="list-card">
            <div class="list-header"><h3>Existing Packages</h3></div>
            <div class="packages-grid">
                @if (Model.Packages.Any())
                {
                    @foreach (var package in Model.Packages)
                    {
                        var firstImage = !string.IsNullOrEmpty(package.ImageURL) ? package.ImageURL.Split(';', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() : "/img/default-package.jpg";
                        <div class="package-management-card">
                            <div class="package-image">
                                <img src="@firstImage" alt="@package.PackageName" onerror="this.src='/img/default-package.jpg'" />
                                <div class="package-actions">
                                    <form method="post" action="@Url.Action("Edit")">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-edit"><i class="fas fa-edit"></i></button>
                                    </form>
                                    <form method="post" action="@Url.Action("Delete")" onsubmit="return confirm('Delete package?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-delete"><i class="fas fa-trash"></i></button>
                                    </form>
                                </div>
                            </div>
                            <div class="package-content">
                                <h4>@package.PackageName</h4>
                                <div class="package-category"><strong>Category:</strong> @package.Category?.CategoryName</div>
                                <div class="package-price">$@package.Price.ToString("N2")</div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state"><h4>No Packages Found</h4></div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- 1. ITINERARY LOGIC ---
        // Keeps track of the next index to use for the form name binding Itinerary[i]
        let itineraryIndex = @(Model.Itinerary?.Count ?? 0);

        // Helper to create a single row
        function createItineraryRowHTML(index, dayNumber, title = "", desc = "") {
            return `
                <div class="card mb-2 p-3 bg-light border itinerary-row">
                    <div class="d-flex justify-content-between">
                        <strong>Day <span class="day-label">${dayNumber}</span></strong>
                        <button type="button" class="btn btn-sm btn-danger py-0" onclick="removeItineraryRow(this)">&times;</button>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm day-input" name="Itinerary[${index}].DayNumber" value="${dayNumber}" readonly />
                        </div>
                        <div class="col-md-10">
                            <!-- Added title-input and required -->
                            <input type="text" class="form-control form-control-sm title-input" name="Itinerary[${index}].Title" value="${title}" placeholder="Title (e.g. Arrival)" required />
                        </div>
                    </div>
                    <div class="mt-2">
                        <!-- Added desc-input and required -->
                        <textarea class="form-control form-control-sm desc-input" name="Itinerary[${index}].ActivityDescription" rows="2" placeholder="Description..." required>${desc}</textarea>
                    </div>
                </div>`;
        }

        // Adds one row manually
        function addItineraryRow(dayNum = null, title = "", desc = "") {
            const container = document.getElementById('itinerary-container');
            const currentRows = container.getElementsByClassName('itinerary-row').length;
            const displayDay = dayNum || (currentRows + 1);

            const div = document.createElement('div');
            div.innerHTML = createItineraryRowHTML(itineraryIndex, displayDay, title, desc);

            // Append the actual div element, not the string container
            container.appendChild(div.firstElementChild);
            itineraryIndex++;
        }

        function removeItineraryRow(btn) {
            btn.closest('.itinerary-row').remove();
            reorderDays();
        }

        // Renumbers days and FIXES indices for MVC binding
        function reorderDays() {
            const rows = document.querySelectorAll('.itinerary-row');
            rows.forEach((row, index) => {
                const newDay = index + 1;

                // 1. Update Visual Label
                row.querySelector('.day-label').innerText = newDay;

                // 2. Update the readonly Day Number Input
                row.querySelector('.day-input').value = newDay;

                // 3. Update the 'name' attributes so MVC binds Itinerary[0], Itinerary[1] correctly
                // Regex looks for Itinerary[<any number>] and replaces with Itinerary[<current index>]
                const inputs = row.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/Itinerary\[\d+\]/, `Itinerary[${index}]`);
                    }
                });
            });
            // Update global index so next added row continues correctly
            itineraryIndex = rows.length;
        }

        // === AUTO SYNC DATE LOGIC ===
        function syncItineraryDays() {
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;

            if (!startStr || !endStr) return;

            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffTime = end - start;

            // Calculate total duration in days (inclusive)
            if (diffTime < 0) return; // Invalid date range, do nothing
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            const container = document.getElementById('itinerary-container');
            let currentRows = container.getElementsByClassName('itinerary-row').length;

            if (totalDays > currentRows) {
                // Add missing days
                for (let i = currentRows + 1; i <= totalDays; i++) {
                    addItineraryRow(i);
                }
            } else if (totalDays < currentRows) {
                // Remove extra days from the bottom
                const rows = container.getElementsByClassName('itinerary-row');
                // Loop backwards to remove from end
                for (let i = currentRows - 1; i >= totalDays; i--) {
                    rows[i].remove();
                }
                // Ensure indices are clean after removal
                reorderDays();
            }
        }

        // === VALIDATION FUNCTION ===
        function validateForm() {
            const rows = document.querySelectorAll('.itinerary-row');
            let isValid = true;
            const errorMsg = document.getElementById('itineraryError');

            // 1. Basic Date & Price Validation (Manual checks)
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const priceInput = document.querySelector('input[name="Price"]');
            const slotsInput = document.querySelector('input[name="AvailableSlots"]');

            if (startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                if (endDate <= startDate) {
                    alert('End date must be after start date.');
                    return false;
                }
            }

            if (priceInput.value && parseFloat(priceInput.value) <= 0) {
                alert('Price must be greater than 0.');
                return false;
            }

            if (slotsInput.value && parseInt(slotsInput.value) <= 0) {
                alert('Available slots must be greater than 0.');
                return false;
            }

            const categorySelect = document.getElementById('categorySelect');
            const newCategoryInput = document.getElementById('newCategoryInput');
            if (categorySelect.value === '' && (!newCategoryInput.value || newCategoryInput.value.trim() === '')) {
                alert('Please select an existing category or enter a new category name.');
                return false;
            }

            // 2. Itinerary Validation
            // If dates are selected, ensure at least one day exists
            if(startDateInput.value && endDateInput.value && rows.length === 0) {
                 isValid = false;
            }

            // Loop through all itinerary rows to check empty fields
            rows.forEach(row => {
                const title = row.querySelector('.title-input').value.trim();
                const desc = row.querySelector('.desc-input').value.trim();

                if (!title || !desc) {
                    isValid = false;
                    // Highlight empty fields
                    if(!title) row.querySelector('.title-input').classList.add('is-invalid');
                    if(!desc) row.querySelector('.desc-input').classList.add('is-invalid');
                } else {
                    row.querySelector('.title-input').classList.remove('is-invalid');
                    row.querySelector('.desc-input').classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                errorMsg.classList.remove('d-none');
                errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false; // Prevent submission
            } else {
                errorMsg.classList.add('d-none');
                return true; // Allow submission
            }
        }

        // --- 2. EXISTING LOGIC (Images, Inclusions) ---
        let inclusionIndex = @Model.Inclusions.Count;
        const dt = new DataTransfer();

        function handleFileSelect(input) {
            const container = document.getElementById('previewContainer');
            const clearBtn = document.getElementById('clearNewBtn');
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) dt.items.add(input.files[i]);
                input.files = dt.files;
                renderNewImages();
                container.style.display = 'block';
                clearBtn.style.display = 'block';
            }
        }

        function renderNewImages() {
            const gallery = document.getElementById('newImagesGallery');
            gallery.innerHTML = '';
            if (dt.files.length === 0) {
                document.getElementById('previewContainer').style.display = 'none';
                document.getElementById('clearNewBtn').style.display = 'none';
                return;
            }
            for (let i = 0; i < dt.files.length; i++) {
                const file = dt.files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = `<img src="${e.target.result}" /><span class="remove-btn" onclick="removeNewFile(${i})">&times;</span>`;
                    gallery.appendChild(div);
                }
                reader.readAsDataURL(file);
            }
        }

        function removeNewFile(index) {
            dt.items.remove(index);
            document.getElementById('imageInput').files = dt.files;
            renderNewImages();
        }

        function clearNewUploads() {
            dt.items.clear();
            document.getElementById('imageInput').files = dt.files;
            renderNewImages();
        }

        function toggleDeletion(path, elementId) {
            const container = document.getElementById('deletedImagesContainer');
            const element = document.getElementById(elementId);
            if (element.classList.contains('deleted')) {
                element.classList.remove('deleted');
                const input = document.querySelector(`input[name="DeleteImagePaths"][value="${path}"]`);
                if(input) input.remove();
            } else {
                element.classList.add('deleted');
                const input = document.createElement('input');
                input.type = 'hidden'; input.name = 'DeleteImagePaths'; input.value = path;
                container.appendChild(input);
            }
        }

        function addInclusion() {
            const container = document.getElementById('inclusions-container');
            const div = document.createElement('div');
            div.className = 'inclusion-item mb-2';
            div.innerHTML = `<div class="input-group"><input type="text" class="form-control" name="Inclusions[${inclusionIndex}]" placeholder="Enter item" /><button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button></div>`;
            container.appendChild(div);
            inclusionIndex++;
        }

        function removeInclusion(btn) { btn.closest('.inclusion-item').remove(); }

        function toggleNewCategoryInput() {
            const sel = document.getElementById('categorySelect');
            const grp = document.getElementById('newCategoryGroup');
            if (sel && grp) {
                grp.style.display = sel.value === '' ? 'block' : 'none';
                if(sel.value !== '') document.getElementById('newCategoryInput').value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sel = document.getElementById('categorySelect');
            if (sel) { sel.addEventListener('change', toggleNewCategoryInput); toggleNewCategoryInput(); }

            @if (Model.EditingPackageId.HasValue)
            {
                    <text>
                    const s = document.querySelector('input[name="StartDate"]');
                    const e = document.querySelector('input[name="EndDate"]');
                    if (s && s.value === '') s.value = '@Model.Package.StartDate.ToString("yyyy-MM-dd")';
                    if (e && e.value === '') e.value = '@Model.Package.EndDate.ToString("yyyy-MM-dd")';
                    </text>
            }
        });
    </script>
}