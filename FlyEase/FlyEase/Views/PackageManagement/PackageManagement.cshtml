@using FlyEase.ViewModels
@model PackageManagementViewModel

@{
    ViewData["Title"] = " - Package Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/packagemanagement.css" />
<style>
    /* Gallery Styling */
    .image-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .gallery-item {
        position: relative;
        width: 120px;
        height: 120px;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #f9f9f9;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Remove Button Styling */
        .gallery-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 22px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            z-index: 10;
            transition: all 0.2s;
        }

            .gallery-item .remove-btn:hover {
                background: #cc0000;
                transform: scale(1.1);
            }

        /* Style for items marked as deleted */
        .gallery-item.deleted {
            opacity: 0.5;
            border: 2px dashed red;
            filter: grayscale(100%);
        }

            .gallery-item.deleted::after {
                content: "REMOVED";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: red;
                font-weight: 900;
                font-size: 14px;
                background: rgba(255,255,255,0.8);
                padding: 4px 8px;
                border-radius: 4px;
                pointer-events: none;
            }
</style>

<div class="management-hero">
    <div class="hero-content">
        <h1>Package Management</h1>
        <p>Create, edit, and manage travel packages</p>
    </div>
</div>

<div class="management-container">
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger")">
            @Model.Message
        </div>
    }

    <div class="management-grid">
        <div class="form-card">
            <div class="form-header">
                <h3>@(Model.EditingPackageId == null ? "Create New Package" : "Edit Package")</h3>
            </div>
            <div class="form-body">
                <form method="post"
                      action="@(Model.EditingPackageId == null ? Url.Action("Create") : Url.Action("Update"))"
                      enctype="multipart/form-data" id="packageForm">
                    @Html.AntiForgeryToken()

                    @if (Model.EditingPackageId.HasValue)
                    {
                        <input type="hidden" name="PackageID" value="@Model.EditingPackageId.Value" />
                    }

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Package Name</label>
                            <input class="form-control" name="PackageName" value="@Model.Package.PackageName" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="CategoryID" id="categorySelect">
                                <option value="">Select Category or Type New One</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.CategoryID" selected="@(category.CategoryID == Model.SelectedCategoryId)">
                                        @category.CategoryName
                                    </option>
                                }
                            </select>
                            <div class="mt-2" id="newCategoryGroup" style="@(string.IsNullOrWhiteSpace(Model.NewCategoryName) && Model.SelectedCategoryId.HasValue ? "display: none;" : "")">
                                <small class="text-muted">Or enter new category:</small>
                                <input type="text" class="form-control mt-1" name="NewCategoryName" id="newCategoryInput" placeholder="Type new category name" value="@Model.NewCategoryName" />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="Description" rows="3">@Model.Package.Description</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Destination</label>
                            <input class="form-control" name="Destination" value="@Model.Package.Destination" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input class="form-control" name="Price" type="number" step="0.01" value="@Model.Package.Price" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input class="form-control" name="StartDate" type="date" value="@(Model.Package.StartDate == default ? "" : Model.Package.StartDate.ToString("yyyy-MM-dd"))" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input class="form-control" name="EndDate" type="date" value="@(Model.Package.EndDate == default ? "" : Model.Package.EndDate.ToString("yyyy-MM-dd"))" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Available Slots</label>
                            <input class="form-control" name="AvailableSlots" type="number" value="@(Model.Package.AvailableSlots == 0 ? "" : Model.Package.AvailableSlots.ToString())" required />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Package Images</label>

                            <div class="input-group">
                                <input class="form-control" name="ImageFiles" id="imageInput" type="file" accept="image/*" multiple onchange="handleFileSelect(this)" />
                                <button type="button" class="btn btn-outline-danger" id="clearNewBtn" style="display:none;" onclick="clearNewUploads()">Clear All New</button>
                            </div>
                            <small class="form-text text-muted">You can select multiple files. They will queue up below.</small>

                            <div class="mt-3" id="previewContainer" style="display:none; border: 1px dashed #28a745; padding: 10px; border-radius: 8px;">
                                <label class="small fw-bold text-success">New Images (To be uploaded):</label>
                                <div class="image-gallery" id="newImagesGallery"></div>
                            </div>

                            <div id="deletedImagesContainer"></div>
                            @if (Model.EditingPackageId.HasValue && Model.ImageList.Any())
                            {
                                <div class="mt-3">
                                    <label class="small fw-bold text-primary">Previously Saved Images:</label>
                                    <div class="image-gallery">
                                        @foreach (var imgPath in Model.ImageList)
                                        {
                                            var uniqueId = "img-" + Math.Abs(imgPath.GetHashCode());
                                            <div class="gallery-item" id="@uniqueId">
                                                <img src="@imgPath" onerror="this.src='/img/default-package.jpg'" />
                                                <span class="remove-btn" onclick="toggleDeletion('@imgPath', '@uniqueId')" title="Delete this image">&times;</span>
                                            </div>
                                        }
                                    </div>
                                    <small class="text-muted fst-italic mt-1 d-block">* Click 'X' to mark images for removal. Changes apply after clicking Update.</small>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Package Inclusions <span class="text-muted fw-light">(Optional)</span></label>
                        <div id="inclusions-container">
                            @for (int i = 0; i < Model.Inclusions.Count; i++)
                            {
                                <div class="inclusion-item mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="Inclusions[@i]" value="@Model.Inclusions[i]" placeholder="Enter inclusion item" />
                                        <button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button>
                                    </div>
                                </div>
                            }
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="addInclusion()">Add Inclusion</button>
                    </div>

                    <div class="form-actions">
                        @if (Model.EditingPackageId == null)
                        {
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create Package
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Update Package
                            </button>
                            <a href="@Url.Action("PackageManagement")" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        }
                    </div>
                </form>
            </div>
        </div>

        <div class="list-card">
            <div class="list-header">
                <h3>Existing Packages</h3>
            </div>
            <div class="packages-grid">
                @if (Model.Packages.Any())
                {
                    @foreach (var package in Model.Packages)
                    {
                        var firstImage = !string.IsNullOrEmpty(package.ImageURL)
                        ? package.ImageURL.Split(';', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault()
                        : "/img/default-package.jpg";
                        <div class="package-management-card">
                            <div class="package-image">
                                <img src="@firstImage" alt="@package.PackageName" onerror="this.src='/img/default-package.jpg'" />
                                <div class="package-actions">
                                    <form method="post" action="@Url.Action("Edit")">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-edit"><i class="fas fa-edit"></i></button>
                                    </form>
                                    <form method="post" action="@Url.Action("Delete")" onsubmit="return confirm('Are you sure you want to delete this package?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@package.PackageID" />
                                        <button type="submit" class="btn-delete"><i class="fas fa-trash"></i></button>
                                    </form>
                                </div>
                            </div>
                            <div class="package-content">
                                <h4>@package.PackageName</h4>
                                <div class="package-category"><strong>Category:</strong> @package.Category?.CategoryName</div>
                                <div class="package-destination"><strong>Destination:</strong> @package.Destination</div>
                                <div class="package-price">$@package.Price.ToString("N2")</div>
                                <p class="package-description">
                                    @(package.Description?.Length > 100 ? package.Description.Substring(0, 100) + "..." : package.Description)
                                </p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h4>No Packages Found</h4>
                        <p>Create your first package to get started!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let inclusionIndex = @Model.Inclusions.Count;

        // --- 1. IMAGE UPLOAD LOGIC (DataTransfer API) ---
        // This "bucket" holds all the files selected for upload
        const dt = new DataTransfer();

        function handleFileSelect(input) {
            const container = document.getElementById('previewContainer');
            const clearBtn = document.getElementById('clearNewBtn');

            if (input.files && input.files.length > 0) {
                // Loop through selected files and add them to our "bucket"
                // This allows appending files rather than replacing them
                for (let i = 0; i < input.files.length; i++) {
                    dt.items.add(input.files[i]);
                }

                // Sync the HTML input with our bucket
                input.files = dt.files;

                // Refresh UI
                renderNewImages();
                container.style.display = 'block';
                clearBtn.style.display = 'block';
            }
        }

        // Render the preview images from the DataTransfer object
        function renderNewImages() {
            const gallery = document.getElementById('newImagesGallery');
            gallery.innerHTML = ''; // Clear current view

            if (dt.files.length === 0) {
                document.getElementById('previewContainer').style.display = 'none';
                document.getElementById('clearNewBtn').style.display = 'none';
                return;
            }

            for (let i = 0; i < dt.files.length; i++) {
                const file = dt.files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    // Note: passed 'i' to removeNewFile so we know which one to delete
                    div.innerHTML = `
                        <img src="${e.target.result}" title="${file.name}" />
                        <span class="remove-btn" onclick="removeNewFile(${i})" title="Remove this upload">&times;</span>
                    `;
                    gallery.appendChild(div);
                }
                reader.readAsDataURL(file);
            }
        }

        // Remove a specific new file by index
        function removeNewFile(index) {
            dt.items.remove(index);
            // Sync input again
            document.getElementById('imageInput').files = dt.files;
            // Re-render (indices shift after removal, so we must redraw)
            renderNewImages();
        }

        // Clear all new uploads
        function clearNewUploads() {
            dt.items.clear();
            document.getElementById('imageInput').files = dt.files;
            renderNewImages();
        }

        // --- 2. EXISTING IMAGE DELETION LOGIC ---
        function toggleDeletion(path, elementId) {
            const container = document.getElementById('deletedImagesContainer');
            const element = document.getElementById(elementId);

            if (element.classList.contains('deleted')) {
                // Undo deletion
                element.classList.remove('deleted');
                const inputToRemove = document.querySelector(`input[name="DeleteImagePaths"][value="${path}"]`);
                if(inputToRemove) inputToRemove.remove();
            } else {
                // Mark for deletion
                element.classList.add('deleted');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'DeleteImagePaths';
                input.value = path;
                container.appendChild(input);
            }
        }

        // --- 3. FORM HELPERS ---
        function addInclusion() {
            const container = document.getElementById('inclusions-container');
            const div = document.createElement('div');
            div.className = 'inclusion-item mb-2';
            div.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" name="Inclusions[${inclusionIndex}]" placeholder="Enter inclusion item" />
                    <button type="button" class="btn btn-danger" onclick="removeInclusion(this)">Remove</button>
                </div>
            `;
            container.appendChild(div);
            inclusionIndex++;
        }

        function removeInclusion(button) {
            button.closest('.inclusion-item').remove();
        }

        function toggleNewCategoryInput() {
            const categorySelect = document.getElementById('categorySelect');
            const newCategoryInput = document.getElementById('newCategoryInput');
            const newCategoryGroup = document.getElementById('newCategoryGroup');

            if (categorySelect && newCategoryInput && newCategoryGroup) {
                if (categorySelect.value === '' || categorySelect.value === null) {
                    newCategoryGroup.style.display = 'block';
                    newCategoryInput.required = true;
                } else {
                    newCategoryGroup.style.display = 'none';
                    newCategoryInput.required = false;
                    newCategoryInput.value = '';
                }
            }
        }

        // --- 4. VALIDATION ON SUBMIT ---
        document.getElementById('packageForm').addEventListener('submit', function (e) {
            const startDateInput = document.querySelector('input[name="StartDate"]');
            const endDateInput = document.querySelector('input[name="EndDate"]');
            const priceInput = document.querySelector('input[name="Price"]');
            const slotsInput = document.querySelector('input[name="AvailableSlots"]');

            if (startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                if (endDate <= startDate) {
                    e.preventDefault();
                    alert('End date must be after start date.');
                    return false;
                }
            }

            if (priceInput.value && parseFloat(priceInput.value) <= 0) {
                e.preventDefault();
                alert('Price must be greater than 0.');
                return false;
            }

            if (slotsInput.value && parseInt(slotsInput.value) <= 0) {
                e.preventDefault();
                alert('Available slots must be greater than 0.');
                return false;
            }

            const categorySelect = document.getElementById('categorySelect');
            const newCategoryInput = document.getElementById('newCategoryInput');
            if (categorySelect.value === '' && (!newCategoryInput.value || newCategoryInput.value.trim() === '')) {
                e.preventDefault();
                alert('Please select an existing category or enter a new category name.');
                return false;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('categorySelect');
            if (categorySelect) {
                categorySelect.addEventListener('change', toggleNewCategoryInput);
                toggleNewCategoryInput();
            }

            @if (Model.EditingPackageId.HasValue)
            {
                    <text>
                    const startDateInput = document.querySelector('input[name="StartDate"]');
                    const endDateInput = document.querySelector('input[name="EndDate"]');
                    if (startDateInput && startDateInput.value === '') startDateInput.value = '@Model.Package.StartDate.ToString("yyyy-MM-dd")';
                    if (endDateInput && endDateInput.value === '') endDateInput.value = '@Model.Package.EndDate.ToString("yyyy-MM-dd")';
                    </text>
            }
        });
    </script>
}