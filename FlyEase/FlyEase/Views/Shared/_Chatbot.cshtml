<div id="flybot-container">
    <button id="flybot-trigger" onclick="toggleChat()">
        <i class="fas fa-robot"></i> Support
    </button>

    <div id="flybot-window" class="shadow-lg">
        <div class="flybot-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-robot me-2"></i>
                <span>FlyEase Assistant</span>
            </div>
            <div>
                <button onclick="clearChat()" class="btn btn-sm text-white me-2" title="Clear History">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button onclick="toggleChat()" class="btn-close btn-close-white btn-sm"></button>
            </div>
        </div>

        <div id="flybot-messages">
        </div>

        <div class="flybot-input-area">
            <input type="text" id="flybot-input" placeholder="Type a question..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<style>
    #flybot-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        font-family: 'Segoe UI', sans-serif;
    }

    #flybot-trigger {
        background: #0066a1;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 15px 25px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        #flybot-trigger:hover {
            transform: scale(1.05);
            background: #005080;
        }

    #flybot-window {
        display: none;
        width: 350px;
        height: 450px;
        background: white;
        border-radius: 15px;
        flex-direction: column;
        overflow: hidden;
        position: absolute;
        bottom: 70px;
        right: 0;
        border: 1px solid #ddd;
    }

    .flybot-header {
        background: linear-gradient(135deg, #0066a1, #004470);
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
    }

    #flybot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .bot-msg, .user-msg {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 0.9rem;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .bot-msg {
        background: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }

    .user-msg {
        background: #0066a1;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .flybot-input-area {
        padding: 10px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: white;
    }

    #flybot-input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        outline: none;
    }

        #flybot-input:focus {
            border-color: #0066a1;
        }
</style>

<script>
    // Constants for LocalStorage Keys
    const STORAGE_KEY_MSG = 'flyease_chat_history';
    const STORAGE_KEY_STATE = 'flyease_chat_open';

    document.addEventListener("DOMContentLoaded", function() {
        loadChatState();
    });

    function loadChatState() {
        // 1. Restore Open/Close State
        const isOpen = localStorage.getItem(STORAGE_KEY_STATE) === 'true';
        const window = document.getElementById('flybot-window');
        if (isOpen) {
            window.style.display = 'flex';
        }

        // 2. Restore Messages
        const history = localStorage.getItem(STORAGE_KEY_MSG);
        const container = document.getElementById('flybot-messages');

        if (history) {
            // Load existing chat
            const messages = JSON.parse(history);
            messages.forEach(msg => {
                appendMessageToDOM(msg.text, msg.className);
            });
        } else {
            // New user? Add default welcome message
            const welcomeText = `Hello! I'm FlyBot 🤖. I can help with:
                <ul>
                    <li>Refund Policies</li>
                    <li>How to Book</li>
                    <li>Payment Issues</li>
                    <li>Contact Info</li>
                </ul>
                Try asking "How do I cancel?"`;

            // We append it but DO NOT save it yet (optional)
            // Or we can save it so it persists. Let's save it.
            addMessageLogic(welcomeText, 'bot-msg');
        }
    }

    function toggleChat() {
        const window = document.getElementById('flybot-window');
        if (window.style.display === 'flex') {
            window.style.display = 'none';
            localStorage.setItem(STORAGE_KEY_STATE, 'false');
        } else {
            window.style.display = 'flex';
            localStorage.setItem(STORAGE_KEY_STATE, 'true');
            // Scroll to bottom when opening
            const container = document.getElementById('flybot-messages');
            container.scrollTop = container.scrollHeight;
        }
    }

    function clearChat() {
        localStorage.removeItem(STORAGE_KEY_MSG);
        document.getElementById('flybot-messages').innerHTML = '';
        // Reload default welcome
        loadChatState();
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
        const inputField = document.getElementById('flybot-input');
        const userText = inputField.value.trim();
        if (!userText) return;

        // 1. Add User Message
        addMessageLogic(userText, 'user-msg');
        inputField.value = '';

        // 2. Simulate "Thinking" delay
        setTimeout(() => {
            const botResponse = getBotBrainResponse(userText);
            addMessageLogic(botResponse, 'bot-msg');
        }, 600);
    }

    // Helper: Adds to DOM AND saves to Storage
    function addMessageLogic(text, className) {
        // 1. Show it
        appendMessageToDOM(text, className);

        // 2. Save it to LocalStorage
        let history = localStorage.getItem(STORAGE_KEY_MSG);
        let messages = history ? JSON.parse(history) : [];
        messages.push({ text: text, className: className });
        localStorage.setItem(STORAGE_KEY_MSG, JSON.stringify(messages));
    }

    // Helper: Just adds to DOM (used by Load)
    function appendMessageToDOM(text, className) {
        const msgDiv = document.createElement('div');
        msgDiv.className = className;
        msgDiv.innerHTML = text;
        const container = document.getElementById('flybot-messages');
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight; // Auto scroll
    }

    // === THE AI LOGIC ===
    function getBotBrainResponse(input) {
        input = input.toLowerCase();

        if (input.includes("hello") || input.includes("hi") || input.includes("hey"))
            return "Hi there! 👋 How can I help you plan your trip today?";

        if (input.includes("cancel") || input.includes("refund"))
            return "You can cancel your booking from your <b>Profile Dashboard</b>. <br>• > 7 days before: Full Refund<br>• < 3 days: No Refund.";

        if (input.includes("book") || input.includes("reservation"))
            return "To make a booking, browse our <b>Packages</b> page, select a destination, and click 'Book Now'.";

        if (input.includes("pay") || input.includes("card") || input.includes("money"))
            return "We accept Visa, Mastercard, and Online Banking (FPX). All payments are secure.";

        if (input.includes("contact") || input.includes("phone") || input.includes("support"))
            return "You can reach our human support team at <b>+60 11-1685 8138</b> or email <b>support@flyease.com</b>.";

        if (input.includes("password") || input.includes("login"))
            return "If you forgot your password, go to the Login page and click 'Forgot Password' to reset it.";

        if (input.includes("discount") || input.includes("promo"))
             return "Check our 'Discounts' page! Or rate a completed trip to earn a special 20% off code.";

        return "I'm not sure about that yet. 😅 Try asking about 'refunds', 'payments', or 'contact'.";
    }
</script>