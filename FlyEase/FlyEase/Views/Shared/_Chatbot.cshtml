<div id="flybot-trigger-container">
    <div id="flybot-badge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="display:none;">1</div>
    <button id="flybot-trigger" onclick="openChat()">
        <i class="fas fa-robot"></i> <span class="d-none d-md-inline ms-2">Support</span>
    </button>
</div>

<div id="flybot-window" class="shadow-lg">
    <div class="flybot-header" id="flybot-header">
        <div class="d-flex align-items-center">
            <div class="bg-white text-primary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 30px; height: 30px;">
                <i class="fas fa-robot small"></i>
            </div>
            <span class="fw-bold">FlyEase Assistant</span>
        </div>
        <div class="window-controls">
            <button onclick="minimizeChat()" title="Minimize"><i class="fas fa-minus"></i></button>
            <button onclick="toggleMaximize()" title="Resize/Maximize"><i class="far fa-square"></i></button>
            <button onclick="closeChat()" title="Close" class="btn-close-custom"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="flybot-content-wrapper">
        <div id="flybot-messages">
        </div>

        <div id="flybot-typing" class="bot-msg typing-indicator" style="display: none; margin: 0 15px 10px 15px; width: fit-content;">
            <span></span><span></span><span></span>
        </div>

        <div id="flybot-chips" class="flybot-chips-area"></div>

        <div class="flybot-input-area">
            <button onclick="clearChat()" class="btn btn-sm text-muted me-2" title="Clear History"><i class="fas fa-trash-alt"></i></button>
            <input type="text" id="flybot-input" placeholder="Type a message..." onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="sendMessage()" class="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="resize-handle"></div>
</div>

<style>
    /* === TRIGGER BUTTON === */
    #flybot-trigger-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9998;
    }

    #flybot-trigger {
        background: linear-gradient(135deg, #0066a1, #004470);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 25px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0, 102, 161, 0.4);
        cursor: pointer;
        transition: transform 0.2s;
    }

        #flybot-trigger:hover {
            transform: scale(1.05);
        }

    /* === WINDOW === */
    #flybot-window {
        display: none;
        position: fixed;
        z-index: 9999;
        background: white;
        border-radius: 12px;
        border: 1px solid #ccc;
        overflow: hidden;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        min-width: 300px;
        min-height: 400px;
        resize: both;
    }

        #flybot-window.maximized {
            width: 90vw !important;
            height: 90vh !important;
            top: 5vh !important;
            left: 5vw !important;
            bottom: auto !important;
            right: auto !important;
        }

    /* === HEADER === */
    .flybot-header {
        background: linear-gradient(to right, #0066a1, #005080);
        color: white;
        padding: 10px 15px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        flex-shrink: 0;
    }

    .window-controls button {
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        padding: 5px;
        cursor: pointer;
        transition: color 0.2s;
    }

        .window-controls button:hover {
            color: white;
        }

    .btn-close-custom:hover {
        color: #ff6b6b !important;
    }

    /* === CONTENT & MESSAGES === */
    #flybot-content-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        background: #f8f9fa;
    }

    #flybot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        scrollbar-width: thin;
    }

    .bot-msg, .user-msg {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 15px;
        font-size: 0.9rem;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .bot-msg {
        background: white;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
        color: #333;
    }

    .user-msg {
        background: #0066a1;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    /* === CHIPS === */
    .flybot-chips-area {
        padding: 10px 15px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        background: white;
        border-top: 1px solid #eee;
        white-space: nowrap;
        scrollbar-width: thin;
    }

        .flybot-chips-area::-webkit-scrollbar {
            height: 4px;
        }

        .flybot-chips-area::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

    .chip {
        background: #e7f1ff;
        color: #0066a1;
        border: 1px solid #cce5ff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }

        .chip:hover {
            background: #0066a1;
            color: white;
            transform: translateY(-1px);
        }

    /* === INPUT === */
    .flybot-input-area {
        padding: 10px 15px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    #flybot-input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        outline: none;
        margin-right: 10px;
    }

        #flybot-input:focus {
            border-color: #0066a1;
        }

    .send-btn {
        border: none;
        background: none;
        color: #0066a1;
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .send-btn:hover {
            transform: scale(1.2);
        }

    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 15px;
        height: 15px;
        cursor: nwse-resize;
    }

    /* === ANIMATION === */
    .typing-indicator span {
        display: inline-block;
        width: 5px;
        height: 5px;
        background: #999;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1s infinite;
    }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }
</style>

<script>
    const WIN_ID = 'flybot-window';
    const HEADER_ID = 'flybot-header';
    const STORAGE_KEY_MSG = 'flyease_chat_history_v3';
    const STORAGE_KEY_STATE = 'flyease_chat_open';

    const CHIP_OPTIONS = [
        "How to Book?",
        "Refund Policy",
        "Check Booking Status",
        "Payment Options",
        "My Discounts",
        "Cancel Trip",
        "Forgot Password",
        "Contact Support",
        "Office Location",
        "Speak to Human"
    ];

    document.addEventListener("DOMContentLoaded", function() {
        loadChatState();
        dragElement(document.getElementById(WIN_ID));
    });

    // === WINDOW LOGIC ===
    function openChat() {
        const win = document.getElementById(WIN_ID);
        win.style.display = 'flex';
        // Hide trigger button when chat is open
        document.getElementById('flybot-trigger-container').style.display = 'none';
        localStorage.setItem(STORAGE_KEY_STATE, 'true');
        scrollToBottom();
    }

    function minimizeChat() {
        document.getElementById(WIN_ID).style.display = 'none';
        // Show trigger button when chat is minimized
        document.getElementById('flybot-trigger-container').style.display = 'block';
        localStorage.setItem(STORAGE_KEY_STATE, 'false');
    }

    function closeChat() { minimizeChat(); }

    function toggleMaximize() {
        document.getElementById(WIN_ID).classList.toggle('maximized');
    }

    // === DRAG LOGIC ===
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = document.getElementById(HEADER_ID);

        if(header) header.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            if(e.target.closest('button')) return;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            elmnt.style.bottom = "auto";
            elmnt.style.right = "auto";
            elmnt.classList.remove('maximized');
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // === CHAT LOGIC (Connected to ChatbotController) ===
    function loadChatState() {
        if(localStorage.getItem(STORAGE_KEY_STATE) === 'true') {
            openChat();
        }

        const history = localStorage.getItem(STORAGE_KEY_MSG);
        const messagesDiv = document.getElementById('flybot-messages');
        messagesDiv.innerHTML = '';
        if (history) {
            JSON.parse(history).forEach(msg => appendMsgToDOM(msg.text, msg.className));
        } else {
            const welcome = "Hi there! 👋 I'm FlyBot. I can help with bookings, refunds, or general questions.";
            saveMsg(welcome, 'bot-msg');
            appendMsgToDOM(welcome, 'bot-msg');
        }

        showChips(CHIP_OPTIONS);
    }

    function sendMessage(text = null) {
        const input = document.getElementById('flybot-input');
        const txt = text || input.value.trim();
        if(!txt) return;

        // 1. Show User Message
        appendMsgToDOM(txt, 'user-msg');
        saveMsg(txt, 'user-msg');
        input.value = '';
        scrollToBottom();

        // 2. Show Typing Indicator
        const typing = document.getElementById('flybot-typing');
        typing.style.display = 'block';
        scrollToBottom();

        // 3. SEND TO SERVER
        fetch('/Chatbot/GetResponse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: txt })
        })
        .then(response => {
            if (!response.ok) throw new Error("Server Error");
            return response.json();
        })
        .then(data => {
            // 4. Show Bot Response
            setTimeout(() => {
                typing.style.display = 'none';
                appendMsgToDOM(data.response, 'bot-msg');
                saveMsg(data.response, 'bot-msg');
                scrollToBottom();
            }, 500);
        })
        .catch(error => {
            console.error(error);
            typing.style.display = 'none';
            appendMsgToDOM("⚠️ Offline or Server Error.", 'bot-msg');
        });
    }

    function saveMsg(text, className) {
        let history = localStorage.getItem(STORAGE_KEY_MSG);
        let msgs = history ? JSON.parse(history) : [];
        msgs.push({text, className});
        localStorage.setItem(STORAGE_KEY_MSG, JSON.stringify(msgs));
    }

    function appendMsgToDOM(text, className) {
        const div = document.createElement('div');
        div.className = className;
        div.innerHTML = text;
        document.getElementById('flybot-messages').appendChild(div);
    }

    function clearChat() {
        localStorage.removeItem(STORAGE_KEY_MSG);
        loadChatState();
    }

    function scrollToBottom() {
        const div = document.getElementById('flybot-messages');
        div.scrollTop = div.scrollHeight;
    }

    function showChips(opts) {
        const area = document.getElementById('flybot-chips');
        area.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'chip';
            btn.innerText = o;
            btn.onclick = () => sendMessage(o);
            area.appendChild(btn);
        });
    }

    function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
</script>