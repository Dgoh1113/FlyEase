<div id="flybot-trigger-container">
    <div id="flybot-badge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="display:none;">1</div>
    <button id="flybot-trigger" onclick="openChat()">
        <i class="fas fa-robot"></i> <span class="d-none d-md-inline ms-2">Support</span>
    </button>
</div>

<div id="flybot-window" class="shadow-lg">
    <div class="flybot-header" id="flybot-header">
        <div class="d-flex align-items-center">
            <div class="bg-white text-primary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 30px; height: 30px;">
                <i class="fas fa-robot small"></i>
            </div>
            <span class="fw-bold">FlyEase Assistant</span>
        </div>
        <div class="window-controls">
            <button onclick="minimizeChat()" title="Minimize"><i class="fas fa-minus"></i></button>
            <button onclick="toggleMaximize()" title="Resize/Maximize"><i class="far fa-square"></i></button>
            <button onclick="closeChat()" title="Close" class="btn-close-custom"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="flybot-content-wrapper">
        <div id="flybot-messages">
        </div>

        <div id="flybot-typing" class="bot-msg typing-indicator" style="display: none; margin: 0 15px 10px 15px; width: fit-content;">
            <span></span><span></span><span></span>
        </div>

        <div id="flybot-chips" class="flybot-chips-area"></div>

        <div class="flybot-input-area">
            <button onclick="clearChat()" class="btn btn-sm text-muted me-2" title="Clear History"><i class="fas fa-trash-alt"></i></button>
            <input type="text" id="flybot-input" placeholder="Type a message..." onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="sendMessage()" class="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="resize-handle"></div>
</div>

<style>
    /* === TRIGGER BUTTON === */
    #flybot-trigger-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9998; /* Below window */
    }

    #flybot-trigger {
        background: linear-gradient(135deg, #0066a1, #004470);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 25px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0, 102, 161, 0.4);
        cursor: pointer;
        transition: transform 0.2s;
    }

        #flybot-trigger:hover {
            transform: scale(1.05);
        }

    /* === WINDOW (Floating & Draggable) === */
    #flybot-window {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 9999;
        background: white;
        border-radius: 12px;
        border: 1px solid #ccc;
        overflow: hidden; /* Hide resize handles overflowing */
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        /* Default Position & Size */
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        /* Resizable Properties */
        min-width: 300px;
        min-height: 400px;
        resize: both;
    }

        /* Maximized State */
        #flybot-window.maximized {
            width: 90vw !important;
            height: 90vh !important;
            top: 5vh !important;
            left: 5vw !important;
            bottom: auto !important;
            right: auto !important;
        }

    /* === HEADER (Draggable Handle) === */
    .flybot-header {
        background: linear-gradient(to right, #0066a1, #005080);
        color: white;
        padding: 10px 15px;
        cursor: move; /* Shows move cursor */
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        flex-shrink: 0;
    }

    .window-controls button {
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        padding: 5px;
        cursor: pointer;
        transition: color 0.2s;
    }

        .window-controls button:hover {
            color: white;
        }

    .btn-close-custom:hover {
        color: #ff6b6b !important;
    }

    /* Content Wrapper */
    #flybot-content-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        background: #f8f9fa;
    }

    #flybot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        scrollbar-width: thin;
    }

    /* === MESSAGES === */
    .bot-msg, .user-msg {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 15px;
        font-size: 0.9rem;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .bot-msg {
        background: white;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
        color: #333;
    }

    .user-msg {
        background: #0066a1;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    /* === CHIPS (Scrollable) === */
    .flybot-chips-area {
        padding: 10px 15px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        background: white;
        border-top: 1px solid #eee;
        white-space: nowrap;
        scrollbar-width: thin;
    }
        /* Custom Scrollbar for Chips */
        .flybot-chips-area::-webkit-scrollbar {
            height: 4px;
        }

        .flybot-chips-area::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

    .chip {
        background: #e7f1ff;
        color: #0066a1;
        border: 1px solid #cce5ff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }

        .chip:hover {
            background: #0066a1;
            color: white;
            transform: translateY(-1px);
        }

    /* === INPUT AREA === */
    .flybot-input-area {
        padding: 10px 15px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    #flybot-input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 15px;
        outline: none;
        margin-right: 10px;
    }

        #flybot-input:focus {
            border-color: #0066a1;
        }

    .send-btn {
        border: none;
        background: none;
        color: #0066a1;
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .send-btn:hover {
            transform: scale(1.2);
        }

    /* Custom Resize Handle */
    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 15px;
        height: 15px;
        cursor: nwse-resize;
    }

    /* Typing Dots Animation (Razor Compatible @@) */
    .typing-indicator span {
        display: inline-block;
        width: 5px;
        height: 5px;
        background: #999;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1s infinite;
    }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }
</style>

<script>
    const WIN_ID = 'flybot-window';
    const HEADER_ID = 'flybot-header';
    const STORAGE_KEY_MSG = 'flyease_chat_history_v3';
    const STORAGE_KEY_STATE = 'flyease_chat_open';

    // === 1. EXTENDED OPTIONS LIST ===
    const CHIP_OPTIONS = [
        "How to Book?",
        "Refund Policy",
        "Check Booking Status",
        "Payment Options",
        "My Discounts",
        "Cancel Trip",
        "Forgot Password",
        "Contact Support",
        "Office Location",
        "Speak to Human"
    ];

    document.addEventListener("DOMContentLoaded", function() {
        loadChatState();
        dragElement(document.getElementById(WIN_ID));
    });

    // === 2. WINDOW CONTROLS ===
    function openChat() {
        const win = document.getElementById(WIN_ID);
        win.style.display = 'flex';
        document.getElementById('flybot-trigger-container').style.display = 'none';
        localStorage.setItem(STORAGE_KEY_STATE, 'true');
        scrollToBottom();
    }

    function minimizeChat() {
        document.getElementById(WIN_ID).style.display = 'none';
        document.getElementById('flybot-trigger-container').style.display = 'block';
        localStorage.setItem(STORAGE_KEY_STATE, 'false');
    }

    function closeChat() { minimizeChat(); }

    function toggleMaximize() {
        document.getElementById(WIN_ID).classList.toggle('maximized');
    }

    // === 3. DRAGGABLE LOGIC ===
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = document.getElementById(HEADER_ID);

        if(header) header.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            if(e.target.closest('button')) return; // Ignore buttons
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            elmnt.style.bottom = "auto";
            elmnt.style.right = "auto";
            elmnt.classList.remove('maximized');
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // === 4. CHAT LOGIC ===
    function loadChatState() {
        if(localStorage.getItem(STORAGE_KEY_STATE) === 'true') {
            openChat();
        }

        const history = localStorage.getItem(STORAGE_KEY_MSG);
        const messagesDiv = document.getElementById('flybot-messages');
        messagesDiv.innerHTML = '';

        if (history) {
            JSON.parse(history).forEach(msg => appendMsgToDOM(msg.text, msg.className));
        } else {
            const welcome = "Hi there! 👋 I'm FlyBot. I can help with bookings, refunds, or general questions.";
            saveMsg(welcome, 'bot-msg');
            appendMsgToDOM(welcome, 'bot-msg');
        }

        showChips(CHIP_OPTIONS);
    }

    function sendMessage(text = null) {
        const input = document.getElementById('flybot-input');
        const txt = text || input.value.trim();
        if(!txt) return;

        appendMsgToDOM(txt, 'user-msg');
        saveMsg(txt, 'user-msg');
        input.value = '';
        scrollToBottom();

        const typing = document.getElementById('flybot-typing');
        typing.style.display = 'block';
        scrollToBottom();

        setTimeout(() => {
            typing.style.display = 'none';
            const response = getBotResponse(txt);
            appendMsgToDOM(response, 'bot-msg');
            saveMsg(response, 'bot-msg');
            scrollToBottom();
        }, 800);
    }

    function saveMsg(text, className) {
        let history = localStorage.getItem(STORAGE_KEY_MSG);
        let msgs = history ? JSON.parse(history) : [];
        msgs.push({text, className});
        localStorage.setItem(STORAGE_KEY_MSG, JSON.stringify(msgs));
    }

    function appendMsgToDOM(text, className) {
        const div = document.createElement('div');
        div.className = className;
        div.innerHTML = text;
        document.getElementById('flybot-messages').appendChild(div);
    }

    function clearChat() {
        localStorage.removeItem(STORAGE_KEY_MSG);
        loadChatState();
    }

    function scrollToBottom() {
        const div = document.getElementById('flybot-messages');
        div.scrollTop = div.scrollHeight;
    }

    function showChips(opts) {
        const area = document.getElementById('flybot-chips');
        area.innerHTML = '';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'chip';
            btn.innerText = o;
            btn.onclick = () => sendMessage(o);
            area.appendChild(btn);
        });
    }

    function handleEnter(e) { if(e.key==='Enter') sendMessage(); }

    // === 5. BOT BRAIN (Updated for 10 options) ===
    function getBotResponse(input) {
        input = input.toLowerCase();

        // Greetings
        if(input.match(/(hello|hi|hey)/)) return "Hello! 👋 Select an option below or type your question.";

        // Booking Status
        if(input.includes("status") || input.includes("check booking"))
            return "You can check your current booking status in your <a href='/Auth/Profile'>Profile Dashboard</a>.";

        // Refunds / Cancel
        if(input.includes("refund") || input.includes("cancel"))
            return "<b>Cancellation Policy:</b><br>✅ > 7 days: Full Refund<br>⚠️ < 3 days: No Refund<br>Go to <a href='/Auth/Profile'>Profile</a> to manage bookings.";

        // How to Book
        if(input.includes("book") || input.includes("package"))
            return "Check out our <a href='/Home/Packages'>Packages Page</a> to find your dream destination! 🌍 Click 'Book Now' on any package.";

        // Payment
        if(input.includes("pay") || input.includes("card") || input.includes("method"))
            return "We accept: <br>💳 Visa / Mastercard<br>🏦 Online Banking (FPX)<br>📱 Touch 'n Go eWallet.";

        // Forgot Password
        if(input.includes("password") || input.includes("reset"))
            return "No worries! Go to the <a href='/Auth/Login'>Login Page</a> and click 'Forgot Password' to reset it.";

        // Contact / Human / Office
        if(input.includes("contact") || input.includes("call") || input.includes("human") || input.includes("speak"))
            return "Our support team is available 9AM - 6PM.<br>📞 <b>+60 11-1685 8138</b><br>📧 support@flyease.com";

        if(input.includes("location") || input.includes("office") || input.includes("address"))
            return "<b>FlyEase HQ:</b><br>Level 5, Menara FlyEase,<br>Jalan Tun Razak, 50400 Kuala Lumpur.";

        // Discounts
        if(input.includes("discount") || input.includes("code") || input.includes("promo"))
            return "Visit the <a href='/Discount/Discounts'>Discounts Page</a> for the latest promo codes! 🎁";

        return "I'm mostly trained on Bookings & Refunds. Try selecting a topic from the list above! 😅";
    }
</script>